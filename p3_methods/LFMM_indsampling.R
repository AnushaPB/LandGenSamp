set.seed(42)
#paths
library("here") 
#to install LFMM:
#devtools::install_github("bcm-uga/lfmm")
library("lfmm") #LFMM
library("vcfR")
library("foreach")
library("doParallel")
library("AssocTests")

#read in general functions and objects
source("general_functions.R")
source("LFMM_functions.R")

#register cores
cores <- 20
cl <- makeCluster(cores)
registerDoParallel(cl)

system.time(
  res_lfmm <- foreach(i=1:nrow(params), .combine=rbind, .packages = c("here", "vcfR", "lfmm", "stringr", "AssocTests", "adegenet", "purrr")) %dopar% {
    
    #set of parameter names in filepath form (for creating temp files)
    paramset <- paste0("K",params[i,"K"],
                       "_phi",params[i,"phi"]*100,
                       "_m",params[i,"m"]*100,
                       "_seed",params[i,"seed"],
                       "_H",params[i,"H"]*100,
                       "_r",params[i,"r"]*100,
                       "_it",params[i,"it"])
    
    #skip iteration if files do not exist
    gen_filepath <- create_filepath(i, params = params, "gen")
    gsd_filepath <- create_filepath(i, params = params, "gsd")
    loci_filepath <- create_filepath(i, params = params, "loci")
    skip_to_next <- FALSE
    if(file.exists(loci_filepath) == FALSE | file.exists(gen_filepath) == FALSE | file.exists(gsd_filepath) == FALSE){skip_to_next <- TRUE}
    if(skip_to_next) { print("File does not exist:")
      print(params[i,]) } 
    if(skip_to_next) { result <- NA } 
    
    #run LFMM
    if(skip_to_next == FALSE){
      gen <- get_data(i, params = params, "gen")
      gsd_df <- get_data(i, params = params, "gsd")
      loci_df <- get_data(i, params = params, "loci")
      
      #subsample full data randomly
      s <- sample(nrow(gsd_df), 2000, replace = FALSE)
      gen_2k <- gen[s,]
      gsd_df_2k <- gsd_df[s,]
      
      #run model on full data set
      # full_result <- run_lfmm(gen_2k, gsd_df_2k, loci_df, K = NULL)
      result <- data.frame(params[i,], sampstrat = "full", nsamp = 2000, data.frame(K = NA,
                                                                                    padj = NA,
                                                                                    alpha = NA,
                                                                                    TPRCOMBO = NA, 
                                                                                    TNRCOMBO = NA,
                                                                                    FDRCOMBO = NA, 
                                                                                    FPRCOMBO = NA,
                                                                                    TOTALN = NA, 
                                                                                    TOTALTP = NA, 
                                                                                    TOTALFP = NA, 
                                                                                    TOTALTN = NA,
                                                                                    TOTALFN = NA,
                                                                                    emp1_TPR = NA,
                                                                                    emp2_TPR = NA,
                                                                                    emp1_mean = NA,
                                                                                    emp2_mean = NA))
      
      for(nsamp in npts){
        for(sampstrat in sampstrats){
          #subsample from data based on sampling strategy and number of samples
          subIDs <- get_samples(params[i,], params, sampstrat, nsamp)
          subgen <- gen[subIDs,]
          subgsd_df <- gsd_df[subIDs,]
          
          #run analysis using subsample
          tryCatch(sub_result <- run_lfmm(subgen, subgsd_df, loci_df, K = NULL), 
                   error = function(e) {
                     err <<- conditionMessage(e)
                     write.table(err, "error_msg.txt")
                     write.csv(subgen, "error_subgen.csv", row.names = FALSE)
                     write.csv(subgsd_df, "error_subgsd_df.csv", row.names = FALSE)
                     
                     message(err)
                     
                     stop(err)})
          
          #save and format new result
          sub_result <- data.frame(params[i,], sampstrat = sampstrat, nsamp = nsamp, sub_result)
          
          #bind results
          result <- rbind.data.frame(result, sub_result)
          
        }
      }
    }
    
    return(result)
    
    gc()
  }
)


#stop cluster
stopCluster(cl)

write.csv(res_lfmm, "outputs/lfmm_indsampling_results.csv", row.names = FALSE)

