---
title: "Optimizing sampling design for landscape genomics: GEA results"
author: "Anusha P. Bishop, Drew E. Terasaki Hart, Ian J. Wang"
output: 
  html_document:
    toc: true
---

```{r, warning = FALSE, message = FALSE, include = FALSE}
library("here")
library("sjPlot")
library("tidyverse")
library("lme4")
library("viridis")
library("lmerTest")
library("ggplot2")
library("gridExtra")
library("grid")
library("gt")
library("purrr")
library("ggpubr")

source(here("p4_analysis", "analysis_functions.R"))

p4path <- here("p4_analysis", "outputs")
p3path <- here("p3_methods", "outputs")

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, results = FALSE, message = FALSE)
```

------------------------------------------------------------------------

<font size="4"> **Plots:** </font>

**Summary plots** - For the summary plots, each plot is paired by parameter level vertically and the values in the cells are the mean value across all of the simulations for that parameter level. Sample strategy is on the y-axis and number of sites is on the x-axis.Note that each average encompasses all of the other varying simulation parameters.

**Full plots** - For the full plots, Each plot represents a unique simulation and the values in the cells are the mean value across all of the 10 iterations of that simulation across all three unique landscape seeds (i.e., all three sets of Neutral Landscape Models) for a total of 30 replicates. Sample strategy is on the y-axis and number of sites is on the x-axis. Since there are a many simulations presented in the full plots, here is a handy key for how the different parameters are laid out within them (H = High, L = Low):

```{r,fig.width = 9, fig.height = 4}
df <- format_data("gdm2", "individual") 

ggdf <- make_ggdf(df, stat_name = "geo_p") 

plots <-
  map2(
    c("K", "m", "phi", "H", "r"),
    c(
      "Population size (K)",
      "Migration (m)",
      "Selection strength (phi)",
      "Spatial autocorrelation (H)",
      "Environmental correlation (r)"
    ),
    ~ ggplot(ggdf, aes(x = nsamp, y = sampstrat)) +
      geom_tile(aes(fill = .data[[.x]])) +
      theme_bw() +
      coord_fixed() +
      facet_wrap(~ group, nrow = 4) +
      theme(
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "right",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = unit(rep(0.4, 4), "cm"),
        strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(color = "black"),
        plot.title = element_text(size = 12, face = "bold")
      ) +
      labs(fill = "Level") +
      ggtitle(.y)
  )

do.call(ggarrange, c(plots, common.legend = TRUE, legend.position = "right"))
```

<font size="4"> **Methods:** </font>

**K** - number of latent factors used in LFMM

**TPR** - True Positive Rate

**FDR** - False Discovery Rate

**strict vs relaxed TPR/FDR** - "relaxed" means any adaptive loci identified was counted as a true positive and "strict" means only an adaptive loci identified with the correct environmental variable was counted as a true positive

**pRDA** - partial RDA conditioning on two PC axes to control for population genetic structure

**lasso vs ridge**- "lasso" and "ridge" are different methods utilized by LFMM that have different penalization functions (Caye et al., 2019)

------------------------------------------------------------------------

```{r}
stats <- c("TPRCOMBO_relaxed", "TPRCOMBO_strict", "FDRCOMBO_relaxed", "FDRCOMBO_strict")
```

# 1. LFMM

## 1.1 Individual sampling

### 1.1.1 Summary plots

```{r, fig.width=14, fig.height=7, include = FALSE}
lfmm_ind <- format_data("lfmm", "individual") 

lfmm_ind_tidy <- 
  lfmm_ind %>% 
  group_by(lfmm_method) %>%
  group_split()

summary_plots <-
  map(c(stats, "TOTALN", "K_factor"),
      ~ map(
        lfmm_ind_tidy,
        lfmm_plotter,
        stat = .x,
        maxv = agg_mm(lfmm_ind_tidy, .x)["max"],
        minv = agg_mm(lfmm_ind_tidy, .x)["min"]
      ))
```

```{r, fig.width=14, fig.height=7}
walk(summary_plots, ~walk(.x, grid.arrange))
```

### 1.1.2 Linear mixed effects models

*Only results from the ridge method are used from here on out*

```{r, include = FALSE}
lfmm_ind <- 
  lfmm_ind %>% 
  filter(lfmm_method == "ridge") 

```

```{r, message = FALSE, results = 'asis', results='asis', echo = FALSE}
walk(stats, ~run_lmer(lfmm_ind,  stat = .x, 
                      filepath = make_lmer_path("lfmm", "ind", .x)))
```

### 1.1.3 Full plots

```{r,fig.width = 21, fig.height = 13}
walk(c(stats, "TOTALN", "K_factor"), ~print(MEGAPLOT(lfmm_ind, stat = .x)))
```

## 1.2 Site sampling

### 1.2.1 Summary plots

```{r, fig.width=14, fig.height=7, include = FALSE}
lfmm_site <- format_data("lfmm", "site") 

lfmm_site_tidy <- lfmm_site %>% 
  group_by(lfmm_method) %>%
  group_split()

summary_plots <-
  map(c(stats, "TOTALN", "K_factor"),
      ~ map(
        lfmm_site_tidy,
        lfmm_plotter,
        stat = .x,
        maxv = agg_mm(lfmm_site_tidy, .x)["max"],
        minv = agg_mm(lfmm_site_tidy, .x)["min"]
      ))
```

```{r, fig.width=14, fig.height=7}
walk(summary_plots, ~walk(.x, grid.arrange))
```

### 1.1.2 Linear mixed effects models

*Only results from the ridge method are used from here on out*

```{r}
lfmm_site <- 
  lfmm_site %>% 
  filter(lfmm_method == "ridge") 
```

```{r, message = FALSE, results = 'asis', results='asis', echo = FALSE}
walk(stats, ~run_lmer(lfmm_site, .x, 
                      filepath = make_lmer_path("lfmm", "site", .x)))
```

### 1.2.3 Full plots

```{r,fig.width = 21, fig.height = 13}
walk(c(stats, "TOTALN", "K_factor"), ~print(MEGAPLOT(lfmm_site, stat = .x)))
```

# 2. RDA

## 2.1 Individual sampling

### 2.1.1 Summary plots

```{r, fig.width=14, fig.height=7, include = FALSE}
rda_ind <- format_data("rda", "individual") 

rda_ind_tidy <- 
  rda_ind %>%
  group_by(correctPC) %>%
  group_split()

summary_plots <-
  map(c(stats, "TOTALN"),
      ~ map(
        rda_ind_tidy,
        rda_plotter,
        stat = .x,
        maxv = agg_mm(rda_ind_tidy, .x)["max"],
        minv = agg_mm(rda_ind_tidy, .x)["min"]
      ))
```

```{r, fig.width=14, fig.height=7}
walk(summary_plots, ~walk(.x, grid.arrange))
```

### 2.1.2 Linear mixed effects models

*Only results from the standard RDA (not the partial RDA) are used from here on out*

```{r}
rda_ind <- 
  rda_ind %>% 
  filter(correctPC == "FALSE") 
```

```{r, message = FALSE, results = 'asis', results='asis', echo = FALSE}
walk(stats, ~run_lmer(rda_ind, .x, 
                      filepath = make_lmer_path("rda", "ind", .x)))
```

### 1.1.3 Full plots

```{r,fig.width = 21, fig.height = 13}
walk(c(stats, "TOTALN"), ~print(MEGAPLOT(rda_ind, stat = .x)))
```

## 2.2 Site sampling

### 2.2.1 Summary plots

```{r, fig.width=14, fig.height=7, include = FALSE}
rda_site <- format_data("rda", "site") 

rda_site_tidy <- 
  rda_site %>%
  group_by(correctPC) %>%
  group_split()

summary_plots <-
  map(c(stats, "TOTALN"),
      ~ map(
        rda_site_tidy,
        rda_plotter,
        stat = .x,
        maxv = agg_mm(rda_site_tidy, .x)["max"],
        minv = agg_mm(rda_site_tidy, .x)["min"]
      ))
```

```{r, fig.width=14, fig.height=7}
walk(summary_plots, ~walk(.x, grid.arrange))
```

### 2.2.2 Linear mixed effects models

*Only results from the standard RDA (not the partial RDA) are used from here on out*

```{r}
rda_site <- 
  rda_site %>% 
  filter(correctPC == "FALSE") 
```

```{r, message = FALSE, results = 'asis', results='asis', echo = FALSE}
walk(stats, ~run_lmer(rda_site, .x, 
                     filepath = make_lmer_path("rda", "site", .x)))
```

### 2.2.3 Full plots

```{r,fig.width = 21, fig.height = 13}
walk(c(stats, "TOTALN"), ~print(MEGAPLOT(rda_site, stat = .x)))
```

------------------------------------------------------------------------

# Figures:

```{r, fig.width = 11, fig.height = 4.75}
df <- 
  bind_rows(data.frame(lfmm_ind, method = "LFMM", sampling = "individual"),
            data.frame(rda_ind, method = "RDA", sampling = "individual"),
            data.frame(lfmm_site, method = "LFMM", sampling = "site"),
            data.frame(rda_site, method = "RDA", sampling = "site"))

ggdf <- 
  df %>%
  mutate(scenario = case_when(K == 2 & m == 1 & phi == 1 & r == 0.3 & H == 0.5 ~ "best",
                              K == 1 & m == 0.25 & phi == 0.5 & r == 0.6 & H == 0.05 ~ "worst",
                              .default = NA)) %>%
  group_by(method, sampstrat, nsamp, sampling, scenario) %>%
  summarise_at(c("TPRCOMBO_relaxed", "FDRCOMBO_relaxed"), mean, na.rm = TRUE) %>%
  pivot_longer(c("TPRCOMBO_relaxed", "FDRCOMBO_relaxed"), names_to = "Statistic", values_to = "values") %>%
  mutate(Statistic = make_pretty_names(Statistic)) %>%
  mutate(Statistic = factor(Statistic, levels = c("TPR relaxed", "FDR relaxed"))) %>%
  mutate(Scheme = factor(sampstrat, levels = c("EQ", "T", "R", "G", "EG")))

ind_plts <-
  ggdf %>%
  filter(sampling == "individual") %>%
  group_by(scenario) %>%
  group_split() %>%
  map(~{
    ggplot(.x, aes(x = as.numeric(as.character(nsamp)), y = values, col = Scheme, fill = Scheme, pch = Scheme)) +
    geom_line(data = filter(.x, Scheme == "T"), lwd = 1, alpha = 0.8) +
    geom_point(data = filter(.x, Scheme == "T"), cex = 2, alpha = 0.8) +
    geom_line(data = filter(.x, Scheme == "G"), lwd = 1, alpha = 0.8) +
    geom_point(data = filter(.x, Scheme == "G"), cex = 2, alpha = 0.8) +
    geom_line(data = filter(.x, Scheme == "R"), lwd = 1, alpha = 0.8) +
    geom_point(data = filter(.x, Scheme == "R"), cex = 2, alpha = 0.8) +
    geom_line(data = filter(.x, Scheme == "EG"), lwd = 1, alpha = 0.8) +
    geom_point(data = filter(.x, Scheme == "EG"), cex = 2, alpha = 0.8) +
    ggh4x::facet_grid2(Statistic~method, scales = "free_y", switch = "y") +
    xlab("Number of samples") +
    ylab("") +
    ylim(0,1) +
    theme(panel.border = element_rect(colour = "lightgray", fill = NA),
          strip.background = element_blank(),
          panel.background = element_blank(),
          axis.text = element_text(size = 11),
          strip.text = element_text(size = 12),
          title = element_text(size = 12),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "right",
          strip.placement = "outside") +
    scale_color_manual(values = c("#0D0887FF", "#17c3b2", "#7678ed", "#ED7953FF")) +
    scale_fill_manual(values = c("#0D0887FF", "#17c3b2", "#7678ed", "#ED7953FF")) +
    scale_shape_manual(values = c(21:24)) +
    ggtitle("A. Individual-based sampling")
    
  }) 


site_plts <-
  ggdf %>%
  filter(sampling == "site") %>%
  group_by(scenario) %>%
  group_split() %>%
  map(~{
    ggplot(.x, aes(x = as.numeric(as.character(nsamp)), y = values, col = Scheme, fill = Scheme, pch = Scheme)) +
    geom_line(data = filter(.x, Scheme == "EQ"), lwd = 1, alpha = 0.8) +
    geom_point(data = filter(.x, Scheme == "EQ"), cex = 2, alpha = 0.8) +
    geom_line(data = filter(.x, Scheme == "R"), lwd = 1, alpha = 0.8) +
    geom_point(data = filter(.x, Scheme == "R"), cex = 2, alpha = 0.8) +
    geom_line(data = filter(.x, Scheme == "EG"), lwd = 1, alpha = 0.8) +
    geom_point(data = filter(.x, Scheme == "EG"), cex = 2, alpha = 0.8) +
    ggh4x::facet_grid2(Statistic~method, scales = "free_y", switch = "y") +
    xlab("Number of sites") +
    ylab("") +
    ylim(0,1) +
    theme(panel.border = element_rect(colour = "lightgray", fill = NA),
          strip.background = element_blank(),
          panel.background = element_blank(),
          axis.text = element_text(size = 11),
          strip.text = element_text(size = 12),
          title = element_text(size = 12),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "right",
          strip.placement = "outside") +
    scale_color_manual(values = c("#0D0887FF", "#17c3b2", "#7678ed")) +
    scale_fill_manual(values = c("#0D0887FF", "#17c3b2", "#7678ed")) +
    scale_shape_manual(values = c(21:23)) +
    ggtitle("B. Site-based sampling")
  })

pdf(here("figures", "GEA_plots.pdf"), width = 11, height = 4.5)
grid.arrange(ind_plts[[1]], site_plts[[1]], nrow = 1)
grid.arrange(ind_plts[[2]], site_plts[[2]], nrow = 1)
dev.off()

grid.arrange(ind_plts[[1]], site_plts[[1]], nrow = 1)
grid.arrange(ind_plts[[2]], site_plts[[2]], nrow = 1)
```
