---
title: "Optimizing sampling design for landscape genomics: IBD and IBE results"
author: "Anusha P. Bishop, Drew E. Terasaki Hart, Ian J. Wang"
output: 
  html_document:
    toc: true
---

```{r, warning=FALSE, include = FALSE, message = FALSE, results = 'asis', fig.width = 21, fig.height = 13}
library("here")
library("sjPlot")
library("tidyverse")
library("lme4")
library("viridis")
library("lmerTest")
library("ggplot2")
library("gridExtra")
library("grid")
library("gt")
library("ggthemes")
library("ggpubr")

source(here("p4_analysis", "analysis_functions.R"))

source(here("p3_methods", "IBDIBE_functions.R"))

p4path <- here("p4_analysis", "outputs")
p3path <- here("p3_methods", "outputs")

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, results = FALSE, message = FALSE)
```

***

**Summary plots** - Sample strategy is on the y-axis and number of sites is on the x-axis. Each plot is paired by parameter level vertically and the values in the cells are the mean value across all of the simulations for that parameter level. *Note that each average encompasses all of the other varying simulation parameters as seen in the Full plots*.


**Full plots** - For the full plots, Each plot represents a unique simulation and the values in the cells are the mean value across all of the 10 iterations of that simulation across all three unique landscape seeds (i.e., all three sets of Neutral Landscape Models) for a total of 30 replicates. Sample strategy is on the y-axis and number of sites is on the x-axis. Since there are a many simulations presented in the full plots, here is a handy key for how the different parameters are laid out within them (H = High, L = Low):

```{r,fig.width = 9, fig.height = 4}
df <- format_gdm(here(p3path, "gdm_indsampling_results.csv")) 
ggdf <- make_ggdf(df, stat_name = "geo_p") 

plots <-
  map2(
    c("K", "m", "phi", "H", "r"),
    c(
      "Population size (K)",
      "Migration (m)",
      "Selection strength (phi)",
      "Spatial autocorrelation (H)",
      "Environmental correlation (r)"
    ),
    ~ ggplot(ggdf, aes(x = nsamp, y = sampstrat)) +
      geom_tile(aes(fill = .data[[.x]])) +
      theme_bw() +
      coord_fixed() +
      facet_wrap(~ group, nrow = 4) +
      theme(
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "right",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = unit(rep(0.4, 4), "cm"),
        strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(color = "black"),
        plot.title = element_text(size = 12, face = "bold")
      ) +
      labs(fill = "Level") +
      ggtitle(.y)
  )

do.call(ggarrange, c(plots, common.legend = TRUE, legend.position = "right"))
```

**TPR** - True Positive Rate. The proportion of times there was a positive detection in both the sub-sampled model and the full model. Note that in the case of GDM TPR is frequently NA because there was no detection in the full model.

**FDR** - False Discovery Rate. The proportion of times there was a detection in the sub-sampled model that was not shared with the full model. 

**ME** - mean error was calculated by taking the mean difference between the observed and expected coefficients, because the absolute value is not taken this measurement is used to determine whether over- or underestimation is occurring. For IBE ME the two environmental coefficient errors were averaged.

**MAE** - mean absolute error calculated as the difference between the observed and expected coefficients. For IBE MAE the two environmental coefficient errors were averaged.

*Proportion of negative & significant coefficients* - this only applies to MMRR and IBE and is the proportion of coefficients that were negative & significant. 

*Proportion NA* - this only applies to GDM and IBE and is the proportion of NA p-values due to the variable significance procedure note being able to be carried out because more than two variable coefficients in the model were zero or because one of the models used in the calculation could not be fit. Note that p-values would also be NA in the case of the variable coefficient was zero, but we treated these as cases of no detection in our calculation of TPR/FDR, whereas the other NA values were excluded.

***

```{r}
stats <- 
  c(
    "geo_p_TPR",
    "geo_p_FDR",
    "geo_coeff_err_ae_scale",
    "env_p_TPR",
    "env_p_FDR",
    "env_coeff_err_ae_scale"
  )

plot_stats <- 
  c(
    "geo_coeff_scale", 
    "geo_coeff_err_scale", 
    stats[grepl("geo",stats)], 
    "env_coeff_err_scale", 
    "env_coeff_scale", 
    stats[grepl("env",stats)]
    )
```

# 1. MMRR

## 1.1 Individual sampling

### 1.1.1 Summary plots

```{r, fig.width=14, fig.height=6}
mmrr_ind <- format_mmrr(here(p3path, "mmrr_indsampling_results.csv"))

walk(c(plot_stats, "env_signeg"), ~ ibdibe_plot(mmrr_ind, stat = .x))
```

### 1.1.2 Linear mixed effects models

```{r, message = FALSE, warning = TRUE, results = 'asis'}
walk(stats, ~run_lmer(mmrr_ind, .x, 
                      filepath = make_lmer_path("mmrr", "ind", .x)))
```

### 1.1.3 Full plots

```{r, fig.width = 21, fig.height = 13}
walk(c(plot_stats, "env_signeg"), ~print(MEGAPLOT(mmrr_ind, stat = .x)))
```

## 1.2 Site sampling

### 1.2.1 Summary plots

```{r, fig.width=14, fig.height=6}
mmrr_site <- format_mmrr(here(p3path, "mmrr_sitesampling_results.csv"))

walk(c(plot_stats, "env_signeg"), ~ ibdibe_plot(mmrr_site, stat = .x))
```

### 1.2.2 Linear mixed effects models

```{r, message = FALSE, warning = TRUE, results = 'asis'}
walk(stats, ~run_lmer(mmrr_site, .x, 
                      filepath = make_lmer_path("mmrr", "site", .x)))
```

### 1.2.3 Full plots

```{r, fig.width = 21, fig.height = 13}
walk(c(plot_stats, "env_signeg"), ~print(MEGAPLOT(mmrr_site, stat = .x)))
```

# 2. GDM

## 2.1 Individual sampling

### 2.1.1 Summary plots

```{r, fig.width=14, fig.height=6}
gdm_ind <- format_gdm(here(p3path, "gdm_indsampling_results.csv"))

walk(c(plot_stats, "null_env_p"), ~ ibdibe_plot(gdm_ind, stat = .x))
```

### 2.1.2 Linear mixed effects models

```{r, message = FALSE, warning = TRUE, results = 'asis'}
walk(stats, ~run_lmer(gdm_ind, .x, 
                      filepath = make_lmer_path("gdm", "ind", .x)))
```

### 2.1.3 Full plots

```{r, fig.width = 21, fig.height = 13}
walk(c(plot_stats, "null_env_p"), ~print(MEGAPLOT(gdm_ind, stat = .x)))
```

### 2.1.4 Failed fits

*Occasionally GDM fails to fit a model, in which case an NA value is assigned. Here we check the proportion of NAs (i.e., cases of failed fit) across the simulations:*

<font size="4.5"> **Proportion of failed full models:** </font> 
```{r,  fig.width = 21, fig.height = 13}
MEGAPLOT(gdm_ind, "geo_coeff", aggfunc = "prop_na", colpal = mako(100))
```


## 2.2 Site sampling

### 2.2.1 Summary plots

```{r, fig.width=14, fig.height=6}
gdm_site <- format_gdm(here(p3path, "gdm_sitesampling_results.csv"))

walk(c(plot_stats, "null_env_p"), ~ ibdibe_plot(gdm_site, stat = .x))
```

### 2.2.2 Linear mixed effects models

```{r, message = FALSE, warning = TRUE, results = 'asis'}
walk(stats, ~run_lmer(gdm_site, .x, 
                      filepath = make_lmer_path("gdm", "site", .x)))
```

### 2.2.3 Full plots
```{r, fig.width = 21, fig.height = 13}
walk(c(plot_stats, "null_env_p"), ~print(MEGAPLOT(gdm_site, stat = .x)))
```

### 2.2.4 Failed fits

*Occasionally GDM fails to fit a model, in which case an NA value is assigned. Here we check the proportion of NAs (i.e., cases of failed fit) across the simulations:*

<font size="4.5"> **Proportion of failed models:** </font> 

```{r,  fig.width = 21, fig.height = 13}
MEGAPLOT(gdm_site, "geo_coeff", aggfunc = "prop_na", colpal = mako(100))
```

---

# Figures: 
```{r, fig.width = 11, fig.height = 6.75}
df <- 
  bind_rows(data.frame(mmrr_ind, method = "MMRR", sampling = "individual"),
            data.frame(gdm_ind, method = "GDM", sampling = "individual"),
            data.frame(mmrr_site, method = "MMRR", sampling = "site"),
            data.frame(gdm_site, method = "GDM", sampling = "site"))

stats <- c(
    "geo_p_TPR",
    "geo_p_FDR",
    "geo_coeff_err_ae_scale",
    "env_p_TPR",
    "env_p_FDR",
    "env_coeff_err_ae_scale"
  )

ggdf <- 
  df %>%
  mutate(scenario = case_when(K == 1 & m == 0.25 & phi == 1 & r == 0.3 & H == 0.5 ~ "best",
                              K == 2 & m == 1 & phi == 0.5 & r == 0.6 & H == 0.05 ~ "worst",
                              .default = NA)) %>%
  group_by(method, sampstrat, nsamp, sampling, scenario) %>%
  summarise_at(all_of(stats), mean, na.rm = TRUE) %>%
  pivot_longer(stats, names_to = "Statistic", values_to = "values") %>%
  mutate(Statistic = make_pretty_names(Statistic)) %>%
  mutate(Statistic = factor(Statistic, levels = make_pretty_names(stats))) %>%
  mutate(IB = case_when(grepl("IBD", Statistic) ~ "IBD", grepl("IBE", Statistic) ~ "IBE"))  %>%
  mutate(Scheme = factor(sampstrat, levels = c("EQ", "T", "R", "G", "EG"))) %>%
  mutate(method = factor(method, levels = c("MMRR", "GDM")))

  
fake_point <- 
    data.frame(nsamp = 20, values = c(rep(c(0,0,NA), 2), rep(c(1,1,NA), 2)),
               name = stats) %>%
    mutate(Statistic = factor(make_pretty_names(name), levels = make_pretty_names(stats)))


ind_plts <-
  ggdf %>%
  filter(sampling == "individual") %>%
  group_by(scenario, IB) %>%
  group_split() %>%
  map(~{
    ggplot(.x, aes(x = as.numeric(as.character(nsamp)), y = values)) +
      geom_point(data = fake_point[(fake_point$Statistic %in% .x[["Statistic"]]), ], col = "white") +
      geom_line(data = filter(.x, Scheme == "T"), aes(col = Scheme), lwd = 1, alpha = 0.8) +
      geom_point(data = filter(.x, Scheme == "T"), aes(col = Scheme, fill = Scheme, pch = Scheme), cex = 2, alpha = 0.8) +
      geom_line(data = filter(.x, Scheme == "G"), aes(col = Scheme), lwd = 1, alpha = 0.8) +
      geom_point(data = filter(.x, Scheme == "G"), aes(col = Scheme, fill = Scheme, pch = Scheme), cex = 2, alpha = 0.8) +
      geom_line(data = filter(.x, Scheme == "R"), aes(col = Scheme), lwd = 1, alpha = 0.8) +
      geom_point(data = filter(.x, Scheme == "R"), aes(col = Scheme, fill = Scheme, pch = Scheme), cex = 2, alpha = 0.8) +
      geom_line(data = filter(.x, Scheme == "EG"), aes(col = Scheme), lwd = 1, alpha = 0.8) +
      geom_point(data = filter(.x, Scheme == "EG"), aes(col = Scheme, fill = Scheme, pch = Scheme), cex = 2, alpha = 0.8) +
      ggh4x::facet_grid2(Statistic~method, scales = "free_y") +
      xlab("Number of samples") +
      ylab("Statistic") +
      theme(panel.border = element_rect(colour = "lightgray", fill = NA),
            strip.background = element_rect(fill = "lightgray", colour = "lightgray"),
            panel.background = element_blank(),
            strip.text = element_text(size = 12),
            axis.text = element_text(size = 11),
            title = element_text(size = 12),
            panel.spacing = unit(0.5, "lines"),
            legend.position = "right") +
      scale_color_manual(values = c("#0D0887FF", "#17c3b2", "#7678ed", "#ED7953FF")) +
      scale_fill_manual(values = c("#0D0887FF", "#17c3b2", "#7678ed", "#ED7953FF")) +
      scale_shape_manual(values = c(21:24)) +
      ggtitle("A. Individual-based sampling")
  }) 
  

site_plts <-
  ggdf %>%
  filter(sampling == "site") %>%
  group_by(scenario, IB) %>%
  group_split() %>%
  map(~{
    ggplot(.x, aes(x = as.numeric(as.character(nsamp)), y = values)) +
      geom_point(data = fake_point[(fake_point$Statistic %in% .x[["Statistic"]]), ], col = "white") +
      geom_line(data = filter(.x, Scheme == "EQ"), aes(col = Scheme), lwd = 1, alpha = 0.8) +
      geom_point(data = filter(.x, Scheme == "EQ"), aes(col = Scheme, fill = Scheme, pch = Scheme), cex = 2, alpha = 0.8) +
      geom_line(data = filter(.x, Scheme == "R"), aes(col = Scheme), lwd = 1, alpha = 0.8) +
      geom_point(data = filter(.x, Scheme == "R"), aes(col = Scheme, fill = Scheme, pch = Scheme), cex = 2, alpha = 0.8) +
      geom_line(data = filter(.x, Scheme == "EG"), aes(col = Scheme), lwd = 1, alpha = 0.8) +
      geom_point(data = filter(.x, Scheme == "EG"), aes(col = Scheme, fill = Scheme, pch = Scheme), cex = 2, alpha = 0.8) +
      ggh4x::facet_grid2(Statistic~method, scales = "free_y") +
      xlab("Number of sites") +
      ylab("Statistic") +
      theme(panel.border = element_rect(colour = "lightgray", fill = NA),
            strip.background = element_rect(fill = "lightgray", colour = "lightgray"),
            panel.background = element_blank(),
            strip.text = element_text(size = 12),
            axis.text = element_text(size = 11),
            title = element_text(size = 12),
            panel.spacing = unit(0.5, "lines"),
            legend.position = "right") +
      scale_color_manual(values = c("#0D0887FF", "#17c3b2", "#7678ed")) +
      scale_fill_manual(values = c("#0D0887FF", "#17c3b2", "#7678ed")) +
      scale_shape_manual(values = c(21:23)) +
      ggtitle("B. Site-based sampling")
  })

pdf(here("plots/IBDIBE_plots.pdf"), width = 11, height = 6.75)
grid.arrange(ind_plts[[1]], site_plts[[1]], nrow = 1)
grid.arrange(ind_plts[[2]], site_plts[[2]], nrow = 1)
grid.arrange(ind_plts[[3]], site_plts[[3]], nrow = 1)
grid.arrange(ind_plts[[4]], site_plts[[4]], nrow = 1)
dev.off()

grid.arrange(ind_plts[[1]], site_plts[[1]], nrow = 1)
grid.arrange(ind_plts[[2]], site_plts[[2]], nrow = 1)
grid.arrange(ind_plts[[3]], site_plts[[3]], nrow = 1)
grid.arrange(ind_plts[[4]], site_plts[[4]], nrow = 1)
```


```{r, fig.width = 12, fig.height = 3, include = FALSE}
a <- read.csv(here("p3_methods/outputs/mmrr_indsampling_results.csv"))
b <- read.csv(here("p3_methods/outputs/gdm_indsampling_results.csv"))

a2 <-
  data.frame(a, method = "mmrr") %>% 
  filter(sampstrat == "full") %>% 
  select(K, phi, H, m, r, it, seed, geo_coeff, env1_coeff, env2_coeff, ratio) %>% 
  rename(
    geo_coeff_mmrr = geo_coeff,
    env1_coeff_mmrr = env1_coeff,
    env2_coeff_mmrr = env2_coeff,
    ratio_mmrr = ratio
  )

b2 <-
  data.frame(b, method = "gdm") %>% 
  filter(sampstrat == "full") %>% 
  select(K, phi, H, m, r, it, seed, geo_coeff, env1_coeff, env2_coeff, ratio) %>% 
  rename(
    geo_coeff_gdm = geo_coeff,
    env1_coeff_gdm = env1_coeff,
    env2_coeff_gdm = env2_coeff,
    ratio_gdm = ratio
  )

df <-
  left_join(b2, a2, by = c("K", "phi", "m", "H", "r", "it", "seed")) %>%
  mutate(
    group1 = paste("K", K, "m", m, "phi", phi, "H", H, "r", r, "it", it, "seed", seed),
    group2 =  paste("K", K, "m", m, "H", H),
    group3 =  paste("K", K, "m", m)) %>%
  mutate_at( c("K", "phi", "m", "H", "r", "it", "seed"), as.factor) %>%
  mutate(`Population size` = case_when(K == 1 ~ "low", TRUE ~ "high"),
         `Migration rate` = case_when(m == 0.25 ~ "low", TRUE ~ "high"),
         H = case_when(m == 0.25 ~ "low", TRUE ~ "high")) 

geo <-
  ggplot(df, aes(x = geo_coeff_mmrr, y = geo_coeff_gdm, col = `Population size`, pch =  `Migration rate`)) +
  geom_point(cex = 1.5, alpha = 1) +
  theme_classic()+
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("Geographic distance")

env1 <-
  ggplot(df, aes(x = env1_coeff_mmrr, y = env1_coeff_gdm)) +
  geom_point(aes(col = H, pch =  `Migration rate`), cex = 1.5, alpha = 1) +
  theme_classic() +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("Environmental variable 1")

env2 <- 
  ggplot(df, aes(x = env2_coeff_mmrr, y = env2_coeff_gdm)) +
  geom_point(aes(col = H, pch =  `Migration rate`), cex = 1.5, alpha = 1) +
  theme_classic() +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("Environmental variable 2")

ggarrange(geo, env1, env2, nrow = 1)
```


```{r, fig.width = 8, fig.height = 6, include = FALSE}
ggplot(df, aes(x = geo_coeff_mmrr, y = geo_coeff_gdm, col = `Migration rate`, pch = `Population size`)) +
  geom_point(cex = 2, alpha = 0.5) +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("IBD") +
  theme_classic() +
  facet_wrap(`Population size` ~ `Migration rate`, scales = "free") +
  theme(strip.text = element_blank()) 
```

```{r, fig.width = 6, fig.height = 3, include = FALSE}
ggplot(df, aes(x = env1_coeff_mmrr, y = env1_coeff_gdm, col = H)) +
  geom_point(cex = 2, alpha = 0.3, pch = 16) +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("IBE (env 1)") +
  theme_classic() +
  facet_wrap(~H, scales = "free") +
  theme(strip.text = element_blank()) 

ggplot(df, aes(x = env2_coeff_mmrr, y = env2_coeff_gdm, col = H)) +
  geom_point(cex = 2, alpha = 0.3, pch = 16) +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("IBE (env 1)") +
  theme_classic() +
  facet_wrap(~H, scales = "free") +
  theme(strip.text = element_blank()) 
```






