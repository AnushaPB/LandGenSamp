---
title: "Supplementary File 4: IBD and IBE Results"
output: 
  html_document:
    toc: true
---

```{r, warning=FALSE, include = FALSE, message = FALSE, results = 'asis', fig.width = 21, fig.height = 13}
library("here")
library("sjPlot")
library("tidyverse")
library("lme4")
library("viridis")
library("lmerTest")
library("ggplot2")
library("gridExtra")
library("grid")
library("gt")
library("ggthemes")
library("ggpubr")

source(here("p4_analysis", "analysis_functions.R"))

source(here("p3_methods", "IBDIBE_functions.R"))

p4path <- here("p4_analysis", "outputs")
p3path <- here("p3_methods", "outputs")

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, results = FALSE, message = FALSE)
```

***

**Summary plots** - Sample strategy is on the y-axis and number of sites is on the x-axis. Each plot is paired by parameter level vertically and the values in the cells are the mean value across all of the simulations for that parameter level. *Note that each average encompasses all of the other varying simulation parameters as seen in the Full plots*.


**Full plots** - For the full plots, Each plot represents a unique simulation and the values in the cells are the mean value across all of the 10 iterations of that simulation across all three unique landscape seeds (i.e., all three sets of Neutral Landscape Models) for a total of 30 replicates. Sample strategy is on the y-axis and number of sites is on the x-axis. Since there are a many simulations presented in the full plots, here is a handy key for how the different parameters are laid out within them (H = High, L = Low):

```{r,fig.width = 9, fig.height = 4}
df <- format_gdm(here(p3path, "gdm_indsampling_results.csv")) 
ggdf <- make_ggdf(df, stat_name = "geo_p") 

plots <-
  map2(
    c("K", "m", "phi", "H", "r"),
    c(
      "Population size (K)",
      "Migration (m)",
      "Selection strength (phi)",
      "Spatial autocorrelation (H)",
      "Environmental correlation (r)"
    ),
    ~ ggplot(ggdf, aes(x = nsamp, y = sampstrat)) +
      geom_tile(aes(fill = .data[[.x]])) +
      theme_bw() +
      coord_fixed() +
      facet_wrap(~ group, nrow = 4) +
      theme(
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "right",
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.margin = unit(rep(0.4, 4), "cm"),
        strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(color = "black"),
        plot.title = element_text(size = 12, face = "bold")
      ) +
      labs(fill = "Level") +
      ggtitle(.y)
  )

do.call(ggarrange, c(plots, common.legend = TRUE, legend.position = "right"))
```

**TPR** - True Positive Rate

**FDR** - False Discovery Rate

**ME** - mean error was calculated by taking the mean difference between the observed and expected coefficients, because the absolute value is not taken this measurement is used to determine whether over- or underestimation is occurring. For IBE ME the two environmental coefficient errors were averaged.

**MAE** - mean absolute error calculated as the difference between the observed and expected coefficients. For IBE MAE the two environmental coefficient errors were averaged.



***

```{r}
stats <- 
  c(
    "geo_p_TPR",
    "geo_p_FDR",
    "geo_coeff_err_ae_scale",
    "env_p_TPR",
    "env_p_FDR",
    "env_coeff_err_ae_scale"
  )

plot_stats <- 
  c(
    "geo_coeff_scale", 
    "geo_coeff_err_scale", 
    stats[grepl("geo",stats)], 
    "env_coeff_err_scale", 
    "env_coeff_scale", 
    stats[grepl("env",stats)]
    )
```

# 1. MMRR

## 1.1 Individual sampling

### 1.1.1 Summary plots

```{r, fig.width=14, fig.height=6}
mmrr_ind <- format_mmrr(here(p3path, "mmrr_indsampling_results.csv"))

walk(plot_stats, ~ ibdibe_plot(mmrr_ind, stat = .x))
```

### 1.1.2 Linear mixed effects models

```{r, message = FALSE, warning = TRUE, results = 'asis'}
walk(stats, ~run_lmer(mmrr_ind, .x, 
                      filepath = make_lmer_path("mmrr", "ind", .x)))
```

### 1.1.3 Full plots

```{r, fig.width = 21, fig.height = 13}
walk(plot_stats, ~print(MEGAPLOT(mmrr_ind, stat = .x)))
```

## 1.2 Site sampling

### 1.2.1 Summary plots

```{r, fig.width=14, fig.height=6}
mmrr_site <- format_mmrr(here(p3path, "mmrr_sitesampling_results.csv"))

walk(plot_stats, ~ ibdibe_plot(mmrr_site, stat = .x))
```

### 1.2.2 Linear mixed effects models

```{r, message = FALSE, warning = TRUE, results = 'asis'}
walk(stats, ~run_lmer(mmrr_site, .x, 
                      filepath = make_lmer_path("mmrr", "site", .x)))
```

### 1.2.3 Full plots

```{r, fig.width = 21, fig.height = 13}
walk(plot_stats, ~print(MEGAPLOT(mmrr_site, stat = .x)))
```

# 2. GDM

## 2.1 Individual sampling

### 2.1.1 Summary plots

```{r, fig.width=14, fig.height=6}
gdm_ind <- format_gdm(here(p3path, "gdm_indsampling_results.csv"))

walk(plot_stats, ~ ibdibe_plot(gdm_ind, stat = .x))
```

### 2.1.2 Linear mixed effects models

```{r, message = FALSE, warning = TRUE, results = 'asis'}
walk(stats, ~run_lmer(gdm_ind, .x, 
                      filepath = make_lmer_path("gdm", "ind", .x)))
```

### 2.1.3 Full plots

```{r, fig.width = 21, fig.height = 13}
walk(plot_stats, ~print(MEGAPLOT(gdm_ind, stat = .x)))
```

### 2.1.4 Failed fits

*Occasionally GDM fails to fit a model, in which case an NA value is assigned. Here we check the proportion of NAs (i.e., cases of failed fit) across the simulations:*

<font size="4.5"> **Proportion of failed full models:** </font> 
```{r,  fig.width = 21, fig.height = 13}
MEGAPLOT(gdm_ind, "geo_coeff", aggfunc = "prop_na", colpal = mako(100))
```


## 2.2 Site sampling

### 2.2.1 Summary plots

```{r, fig.width=14, fig.height=6}
gdm_site <- format_gdm(here(p3path, "gdm_sitesampling_results.csv"))

walk(plot_stats, ~ ibdibe_plot(gdm_site, stat = .x))
```

### 2.2.2 Linear mixed effects models

```{r, message = FALSE, warning = TRUE, results = 'asis'}
walk(stats, ~run_lmer(gdm_site, .x, 
                      filepath = make_lmer_path("gdm", "site", .x)))
```

### 2.2.3 Full plots
```{r, fig.width = 21, fig.height = 13}
walk(plot_stats, ~print(MEGAPLOT(gdm_site, stat = .x)))
```

### 2.2.4 Failed fits

*Occasionally GDM fails to fit a model, in which case an NA value is assigned. Here we check the proportion of NAs (i.e., cases of failed fit) across the simulations:*

<font size="4.5"> **Proportion of failed models:** </font> 

```{r,  fig.width = 21, fig.height = 13}
MEGAPLOT(gdm_site, "geo_coeff", aggfunc = "prop_na", colpal = mako(100))
```

---

```{r, fig.width = 6, fig.height = 9, include = FALSE}

stats <- c(
    "geo_p_TPR",
    "geo_p_FDR",
    "geo_coeff_err_ae_scale",
    "env_p_TPR",
    "env_p_FDR",
    "env_coeff_err_ae_scale"
  )

results <- list(mmrr_ind, mmrr_site, gdm_ind, gdm_site)

filt_results_good <- map(results,  ~filter(.x, K == 1, phi == 1, H == 0.5, r == 0.3, m == 0.25))
sub_results_good <- map(filt_results_good, ~ summarize_stats(.x, stats = stats))

filt_results_bad <- map(results,  ~filter(.x, K != 1, phi != 1, H != 0.5, r != 0.3, m != 0.25))
sub_results_bad <- map(filt_results_bad, ~ summarize_stats(.x, stats = stats))

minmax <-
  map(c("min", "max"), \(f) {
    map(c(sub_results_good, sub_results_bad), \(x, cols = colnames(x)[-c(1:2)]) {
      x %>%
        ungroup() %>%
        dplyr::select(all_of(cols)) %>%
        summarize_all(f, na.rm = TRUE)
    }) %>%
      bind_rows() %>%
      summarize_all(f) %>%
      pivot_longer(everything(), names_to = "pretty_names", values_to = f)
  }) %>%
  do.call(what = left_join) %>%
  separate_wider_delim(pretty_names, " ", names = c("IBDIBE", "stat"), cols_remove = FALSE)  

minmax_stats <- 
  minmax %>%
  group_by(stat) %>%
  summarise(min = min(min), max = max(max)) %>%
  right_join(dplyr::select(minmax, -min, -max)) %>%
  mutate(max = case_when(stat == "FDR" ~ 1, .default = max))

ibdibe_stats <- list(IBD = stats[grepl("geo", stats)], IBE = stats[grepl("env", stats)])

iwalk(
  ibdibe_stats,
  ~ make_ibdibe_figs(
    sub_results_good,
    substats = .x,
    minmax_stats = minmax_stats,
    fileprefix = paste0(.y, "_good")
  )
)  

iwalk(
  ibdibe_stats,
  ~ make_ibdibe_figs(
    sub_results_bad,
    substats = .x,
    minmax_stats = minmax_stats,
    fileprefix = paste0(.y, "_bad")
  )
)  
```

```{r, fig.width = 14, fig.height = 14, include = FALSE}
df <- bind_rows(data.frame(mmrr_ind, method = "MMRR", sampling = "individual"),
                data.frame(gdm_ind, method = "GDM", sampling = "individual"),
                data.frame(mmrr_site, method = "MMRR", sampling = "site"),
                data.frame(gdm_site, method = "GDM", sampling = "site"))
ggdf <- 
  df %>%
  filter(sampstrat == "R") %>%
  select(nsamp, sampling, method, all_of(stats)) %>%
  pivot_longer(all_of(stats)) %>%
  group_by(method, name, sampling, nsamp) %>%
  summarise(
    mean_value = mean(value, na.rm = TRUE),
    lower1 = mean(value, na.rm = TRUE) - sd(value, na.rm = TRUE),
    upper1 = mean(value, na.rm = TRUE) + sd(value, na.rm = TRUE),
    lower2 = mean(value, na.rm = TRUE) - 2*sd(value, na.rm = TRUE),
    upper2 = mean(value, na.rm = TRUE) + 2*sd(value, na.rm = TRUE)) %>%
  mutate(lower1 = case_when(lower1 < 0 ~ 0, TRUE ~ lower1),
         upper1 = case_when(upper1 > 1 ~ 1, TRUE ~ upper1),
         lower2 = case_when(lower2 < 0 ~ 0, TRUE ~ lower2),
         upper2 = case_when(upper2 > 1 ~ 1, TRUE ~ upper2)) %>%
  mutate(name = factor(make_pretty_names(name), levels = make_pretty_names(stats)),
         method = factor(method, levels = c("MMRR", "GDM")))

sampling_plot(ggdf)
```


```{r, fig.width = 12, fig.height = 3, include = FALSE}
a <- read.csv(here("p3_methods/outputs/mmrr_indsampling_results.csv"))
b <- read.csv(here("p3_methods/outputs/gdm_indsampling_results.csv"))

a2 <-
  data.frame(a, method = "mmrr") %>% 
  filter(sampstrat == "full") %>% 
  select(K, phi, H, m, r, it, seed, geo_coeff, env1_coeff, env2_coeff, ratio) %>% 
  rename(
    geo_coeff_mmrr = geo_coeff,
    env1_coeff_mmrr = env1_coeff,
    env2_coeff_mmrr = env2_coeff,
    ratio_mmrr = ratio
  )

b2 <-
  data.frame(b, method = "gdm") %>% 
  filter(sampstrat == "full") %>% 
  select(K, phi, H, m, r, it, seed, geo_coeff, env1_coeff, env2_coeff, ratio) %>% 
  rename(
    geo_coeff_gdm = geo_coeff,
    env1_coeff_gdm = env1_coeff,
    env2_coeff_gdm = env2_coeff,
    ratio_gdm = ratio
  )

df <-
  left_join(b2, a2, by = c("K", "phi", "m", "H", "r", "it", "seed")) %>%
  mutate(
    group1 = paste("K", K, "m", m, "phi", phi, "H", H, "r", r, "it", it, "seed", seed),
    group2 =  paste("K", K, "m", m, "H", H),
    group3 =  paste("K", K, "m", m)) %>%
  mutate_at( c("K", "phi", "m", "H", "r", "it", "seed"), as.factor) %>%
  mutate(`Population size` = case_when(K == 1 ~ "low", TRUE ~ "high"),
         `Migration rate` = case_when(m == 0.25 ~ "low", TRUE ~ "high"),
         H = case_when(m == 0.25 ~ "low", TRUE ~ "high")) 

geo <-
  ggplot(df, aes(x = geo_coeff_mmrr, y = geo_coeff_gdm, col = `Population size`, pch =  `Migration rate`)) +
  geom_point(cex = 1.5, alpha = 1) +
  theme_classic()+
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("Geographic distance")

env1 <-
  ggplot(df, aes(x = env1_coeff_mmrr, y = env1_coeff_gdm)) +
  geom_point(aes(col = H, pch =  `Migration rate`), cex = 1.5, alpha = 1) +
  theme_classic() +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("Environmental variable 1")

env2 <- 
  ggplot(df, aes(x = env2_coeff_mmrr, y = env2_coeff_gdm)) +
  geom_point(aes(col = H, pch =  `Migration rate`), cex = 1.5, alpha = 1) +
  theme_classic() +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("Environmental variable 2")

ggarrange(geo, env1, env2, nrow = 1)
```


```{r, fig.width = 8, fig.height = 6}
ggplot(df, aes(x = geo_coeff_mmrr, y = geo_coeff_gdm, col = `Migration rate`, pch = `Population size`)) +
  geom_point(cex = 2, alpha = 0.5) +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("IBD") +
  theme_classic() +
  facet_wrap(`Population size` ~ `Migration rate`, scales = "free") +
  theme(strip.text = element_blank()) 
```

```{r, fig.width = 6, fig.height = 3}
ggplot(df, aes(x = env1_coeff_mmrr, y = env1_coeff_gdm, col = H)) +
  geom_point(cex = 2, alpha = 0.3, pch = 16) +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("IBE (env 1)") +
  theme_classic() +
  facet_wrap(~H, scales = "free") +
  theme(strip.text = element_blank()) 

ggplot(df, aes(x = env2_coeff_mmrr, y = env2_coeff_gdm, col = H)) +
  geom_point(cex = 2, alpha = 0.3, pch = 16) +
  xlab("MMRR Coefficient") +
  ylab("GDM Coefficient") +
  ggtitle("IBE (env 1)") +
  theme_classic() +
  facet_wrap(~H, scales = "free") +
  theme(strip.text = element_blank()) 
```


```{r, fig.width = 10, fig.height = 3}
ggplot(df, aes(x = ratio_mmrr, y = ratio_gdm, col = K, pch = m)) +
  geom_point() +
  facet_wrap(~group3, scales = "free", nrow = 1) +
  theme_classic()
```

```{r, fig.width = 12, fig.height = 4}
df2 <-
  bind_rows(data.frame(a, method = "mmrr"), data.frame(b, method = "gdm")) %>% 
  pivot_longer(c(K, phi, m, H, r), names_to = "params", values_to = "param_level") %>%
  group_by(method) %>%
  mutate(geo_coeff_scale = geo_coeff/max(geo_coeff, na.rm = TRUE),
         env1_coeff_scale = env1_coeff/max(env1_coeff, na.rm = TRUE),
         env2_coeff_scale = env2_coeff/max(env2_coeff, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(params) %>%
  mutate(level = factor(case_when(param_level == min(param_level) ~ "low", TRUE ~"high"))) %>%
  pivot_longer(c(env1_coeff_scale, env2_coeff_scale), values_to = "env_coeff_scale")

ggplot(df2, aes(x = method, y = geo_coeff_scale, fill = level)) +
  geom_boxplot() +
  facet_wrap(~params, nrow = 1)

ggplot(df2, aes(x = method, y = env_coeff_scale, fill = level)) +
  geom_boxplot() +
  facet_wrap(~params, nrow = 1)
```


