---
title: "analysis_tests"
output: html_document
---

```{r}
library("dplyr")
library("car")
library("lsmeans")
library("lme4")
library("viridis")
library("lmerTest")
library("ggplot2")
library("gridExtra")
library("MuMIn")

source("analysis_functions.R")
BuRd <- c("#2066AC", "#4392C2", "#92C4DE", "#D1E5F0", "#F7F7F7", "#FDDBC6", "#F4A581", "#D5604C", "#B2182B")
BlueRed <- colorRampPalette(BuRd, interpolate="linear")
```



#Analysis

```{r}
#number of points to sample
nsamp <- c(36, 81, 144, 225, 324, 2000)
#sampling strategies
sampstrat <- c("rand", "grid", "trans", "envgeo", "full")

#Create dataframe with all variable combos
params_full <- expand.grid(K = c(2, 4), 
                      phi = c(0.1, 0.5),
                      m = c(0.25, 1.0),
                      seed = c(1, 2, 3),
                      H = c(0.05 , 0.5),
                      r = c(0.3, 0.6),
                      nsamp = nsamp,
                      sampstrat = sampstrat,
                      it = 1)

df <- do.call(rbind, lapply(list.files(path = "/Users/Anusha/Documents/GitHub/LandGenSamp/p3_methods/outputs/GDM/", full.names = TRUE), read.csv))

#df <- read.csv("/Users/Anusha/Documents/GitHub/LandGenSamp/p3_methods/outputs/GDM/gdm_results.csv")
df[,colnames(params_full)] <- data.frame(lapply(df[,colnames(params_full)], as.factor))

```


#COEFFICIENTS
```{r, include=FALSE, fig.width=20, fig.height=6}
df$stat <- df$geo_coeff
geoplt <- summary_hplot(df, colpal = "viridis")

df$stat <- df$env1_coeff
env1plt <- summary_hplot(df, colpal = "viridis")

df$stat <- df$env2_coeff
env2plt <- summary_hplot(df, colpal = "viridis")
```

```{r, fig.width=20, fig.height=6}
grid.arrange(geoplt)
grid.arrange(env1plt)
grid.arrange(env2plt)
```
#COEFFICIENTS

## GeoDist Coeff
```{r fig.width=20, fig.height=8}
df$stat <- df$geo_coeff
summary_vplot(df)
summary_hplot(df)

moddf <- df[df$sampstrat != "full",]
```


## full model

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + K*r +
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
combos <- dredge(fullmod)
combos
```

```{r pairwise comparison of npts, fig.width=5, fig.height=5}

model <- lmer(stat ~ nsamp + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ nsamp), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of nsamp`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)

resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(npts))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(npts))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```



```{r pairwise comparison of sampstrat, fig.width=5, fig.height=5}
#TukeyHSD

model <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ sampstrat), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of sampstrat`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)


resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```

#which is best when?
```{r, fig.height=8, fig.width=5}
nsamp_sampstrat_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

```{r fig.width=10, fig.height=10}
sampstrat_nsamp_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

## Env1 Coeff
```{r fig.width=20, fig.height=8}
df$stat <- df$env1_coeff
summary_vplot(df)
summary_hplot(df, colpal = "viridis")

moddf <- df[df$sampstrat != "full",]
```


## full model

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + K*r +
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
combos <- dredge(fullmod)
combos
```

```{r pairwise comparison of npts, fig.width=5, fig.height=5}

model <- lmer(stat ~ nsamp + K + m + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ nsamp), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of nsamp`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)

resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(npts))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(npts))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```



```{r pairwise comparison of sampstrat, fig.width=5, fig.height=5}
#TukeyHSD

model <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ sampstrat), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of sampstrat`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)


resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```

#which is best when?
```{r, fig.height=8, fig.width=5}
nsamp_sampstrat_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

```{r fig.width=10, fig.height=10}
sampstrat_nsamp_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

## Env2 Coeff
```{r fig.width=20, fig.height=8}
df$stat <- df$env2_coeff
summary_vplot(df)
summary_hplot(df, colpal = "viridis")

moddf <- df[df$sampstrat != "full",]
```


## full model

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + K*r +
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
combos <- dredge(fullmod)
combos
```

```{r pairwise comparison of npts, fig.width=5, fig.height=5}

model <- lmer(stat ~ nsamp + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ nsamp), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of nsamp`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)

resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(npts))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(npts))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```



```{r pairwise comparison of sampstrat, fig.width=5, fig.height=5}
#TukeyHSD

model <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ sampstrat), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of sampstrat`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)


resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```

#which is best when?
```{r, fig.height=8, fig.width=5}
nsamp_sampstrat_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

```{r fig.width=10, fig.height=10}
sampstrat_nsamp_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```


#RMSE
## GeoDist RMSE
```{r fig.width=20, fig.height=8}
df$stat <- df$geo_rmse
summary_vplot(df)
summary_hplot(df)

moddf <- df[df$sampstrat != "full",]
```


## full model
```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + K*r +
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
combos <- dredge(fullmod)
combos
```

```{r pairwise comparison of npts, fig.width=5, fig.height=5}

model <- lmer(stat ~ sampstrat + nsamp + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ nsamp), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of nsamp`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)

resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(npts))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(npts))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```



```{r pairwise comparison of sampstrat, fig.width=5, fig.height=5}
#TukeyHSD

model <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ sampstrat), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of sampstrat`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)


resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```

## which is best when?
```{r, fig.height=8, fig.width=5}
nsamp_sampstrat_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

```{r fig.width=10, fig.height=10}
sampstrat_nsamp_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

## model subset by sampling strategy
Determine how sampling strategy affects the relationships between the sim vars/nsamp

```{r fig.width=5, fig.height=4}
sampstrat_mod(df, sampstrat = sampstrat, full = TRUE)
```
```{r fig.width=5, fig.height=4}
nsamp_mod(df, nsamp = nsamp, full = TRUE)
```
## model subset by nsamp and sampling strategy
Determine how sampling strategy/nsamp affects the affects of the sim vars

```{r real code, fig.width=20, fig.height=4}
sampstrat_nsamp_mod_params(df, sampstrat = sampstrat, nsamp = nsamp, alpha = 0.10)
```


## Env1 RMSE
```{r fig.width=20, fig.height=8}
df$stat <- df$env1_rmse
summary_vplot(df)
summary_hplot(df)

moddf <- df[df$sampstrat != "full",]
```


## full model
```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + K*r +
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
combos <- dredge(fullmod)
combos
```

```{r pairwise comparison of npts, fig.width=5, fig.height=5}

model <- lmer(stat ~ sampstrat + nsamp + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ nsamp), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of nsamp`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)

resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(npts))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(npts))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```



```{r pairwise comparison of sampstrat, fig.width=5, fig.height=5}
#TukeyHSD

model <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ sampstrat), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of sampstrat`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)


resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```

#which is best when?
```{r, fig.height=8, fig.width=5}
nsamp_sampstrat_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

```{r fig.width=10, fig.height=10}
sampstrat_nsamp_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

# model subset by sampling strategy
Determine how sampling strategy affects the relationships between the sim vars/nsamp

```{r fig.width=5, fig.height=4}
sampstrat_mod(df, sampstrat = sampstrat, full = TRUE)
```
```{r fig.width=5, fig.height=4}
nsamp_mod(df, nsamp = nsamp, full = TRUE)
```
# model subset by nsamp and sampling strategy
Determine how sampling strategy/nsamp affects the affects of the sim vars

```{r real code, fig.width=20, fig.height=4}
sampstrat_nsamp_mod_params(df, sampstrat = sampstrat, nsamp = nsamp, alpha = 0.10)
```


## Env2 RMSE
```{r fig.width=20, fig.height=8}
df$stat <- df$env2_rmse
summary_vplot(df)
summary_hplot(df)

moddf <- df[df$sampstrat != "full",]
```


## full model
```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + K*r +
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
combos <- dredge(fullmod)
combos
```

```{r pairwise comparison of npts, fig.width=5, fig.height=5}

model <- lmer(stat ~ sampstrat + nsamp + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ nsamp), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of nsamp`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)

resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(npts))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(npts))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```



```{r pairwise comparison of sampstrat, fig.width=5, fig.height=5}
#TukeyHSD

model <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ sampstrat), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of sampstrat`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)


resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```

#which is best when?
```{r, fig.height=8, fig.width=5}
nsamp_sampstrat_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

```{r fig.width=10, fig.height=10}
sampstrat_nsamp_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

# model subset by sampling strategy
Determine how sampling strategy affects the relationships between the sim vars/nsamp

```{r fig.width=5, fig.height=4}
sampstrat_mod(df, sampstrat = sampstrat, full = TRUE)
```
```{r fig.width=5, fig.height=4}
nsamp_mod(df, nsamp = nsamp, full = TRUE)
```
# model subset by nsamp and sampling strategy
Determine how sampling strategy/nsamp affects the affects of the sim vars

```{r real code, fig.width=20, fig.height=4}
sampstrat_nsamp_mod_params(df, sampstrat = sampstrat, nsamp = nsamp, alpha = 0.10)
```


