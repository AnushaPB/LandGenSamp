---
title: "Supplementary File 2: GEA Results"
output: 
  html_document:
    toc: true
---

```{r, warning = FALSE, message = FALSE, include = FALSE}
library("here")
library("sjPlot")
library("tidyverse")
library("lme4")
library("viridis")
library("lmerTest")
library("ggplot2")
library("gridExtra")
library("grid")
library("gt")
library("purrr")
library("ggpubr")

source(here("p4_analysis", "analysis_functions.R"))

p4path <- here("p4_analysis", "outputs")
p3path <- here("p3_methods", "outputs")

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, results = FALSE, message = FALSE)
```

***

<font size="5"> **Key** </font> 

<font size="4"> **Plots:** </font> 

**Summary plots** - Sample strategy is on the y-axis and number of sites is on the x-axis. Each plot is paired by parameter level vertically and the values in the cells are the mean value across all of the simulations for that parameter level. Note that each average encompasses all of the other varying simulation parameters.

**Full plots** - Sample strategy is on the y-axis and number of sites is on the x-axis. Each plot represents a unique simulation and the values in the cells are the mean value across all of the 10 iterations of that simulation across all three unique landscape seeds (i.e., all three sets of Neutral Landscape Models) for a total of 30 replicates. For these plots: K = population size (not to be confused with the number of latent factors (K)), phi = selection strength, m = migration, H = spatial autocorrelation, r = correlation between environmental layers.

<font size="4"> **Methods:** </font> 

**K** - number of latent factors used in LFMM

**TPR** - True Positive Rate 

**FDR** - False Discovery Rate

**lasso vs ridge**- "lasso" and "ridge" are different methods utilized by LFMM that have different penalization functions (Caye et al., 2019)

**pRDA** - partial RDA conditioning on two PC axes to control for population genetic structure

***

```{r}
stats <- c("TPRCOMBO_relaxed", "TPRCOMBO_strict", "FDRCOMBO_relaxed", "FDRCOMBO_strict")
```

# 1. LFMM

## 1.1 Individual sampling

### 1.1.1 Summary plots

```{r, fig.width=14, fig.height=7, include = FALSE}
lfmm_ind <- format_lfmm(here(p3path, "lfmm_indsampling_results.csv")) 

lfmm_ind_tidy <- 
  lfmm_ind %>% 
  group_by(lfmm_method) %>%
  group_split()

summary_plots <-
  map(c(stats, "TOTALN", "K_factor"),
      ~ map(
        lfmm_ind_tidy,
        lfmm_plotter,
        stat = .x,
        maxv = agg_mm(lfmm_ind_tidy, .x)["max"],
        minv = agg_mm(lfmm_ind_tidy, .x)["min"]
      ))
```

```{r, fig.width=14, fig.height=7}
walk(summary_plots, ~walk(.x, grid.arrange))
```

### 1.1.2 Linear mixed effects models

*Only results from the ridge method are used in the final models*

```{r, include = FALSE}
lfmm_ind <- 
  lfmm_ind %>% 
  filter(lfmm_method == "ridge") 
```

```{r, message = FALSE, results = 'asis', results='asis', echo = FALSE}
map(stats, ~run_lmer(lfmm_ind,  stat = .x, 
                      filepath = make_lmer_path("lfmm", "ind", .x)))
```

### 1.1.3 Full plots

```{r,fig.width = 21, fig.height = 13}
walk(c(stats, "TOTALN", "K_factor"), ~print(MEGAPLOT(lfmm_ind, stat = .x)))
```

## 1.2 Site sampling

### 1.2.1 Summary plots

```{r, fig.width=14, fig.height=7, include = FALSE}
lfmm_site <- format_lfmm(here(p3path, "lfmm_sitesampling_results.csv")) 

lfmm_site_tidy <- lfmm_site %>% 
  group_by(lfmm_method) %>%
  group_split()

summary_plots <-
  map(c(stats, "TOTALN", "K_factor"),
      ~ map(
        lfmm_site_tidy,
        lfmm_plotter,
        stat = .x,
        maxv = agg_mm(lfmm_site_tidy, .x)["max"],
        minv = agg_mm(lfmm_site_tidy, .x)["min"]
      ))
```

```{r, fig.width=14, fig.height=7}
walk(summary_plots, ~walk(.x, grid.arrange))
```

### 1.1.2 Linear mixed effects models

*Only results from the ridge method are used in the final models*

```{r}
lfmm_site <- 
  lfmm_site %>% 
  filter(lfmm_method == "ridge") 
```

```{r, message = FALSE, results = 'asis', results='asis', echo = FALSE}
map(stats, ~run_lmer(lfmm_site, .x, 
                      filepath = make_lmer_path("lfmm", "site", .x)))
```

### 1.2.3 Full plots

```{r,fig.width = 21, fig.height = 13}
walk(c(stats, "TOTALN", "K_factor"), ~print(MEGAPLOT(lfmm_site, stat = .x)))
```

# 2. RDA

## 2.1 Individual sampling

### 2.1.1 Summary plots

```{r, fig.width=14, fig.height=7}
rda_ind <- format_rda(here(p3path, "rda_indsampling_results.csv"))
rda_ind_tidy <- 
  rda_ind %>%
  group_by(correctPC) %>%
  group_split()


summary_plots <-
  map(c(stats, "TOTALN"),
      ~ map(
        rda_ind_tidy,
        rda_plotter,
        stat = .x,
        maxv = agg_mm(rda_ind_tidy, .x)["max"],
        minv = agg_mm(rda_ind_tidy, .x)["min"]
      ))
```


```{r, fig.width=14, fig.height=7}
walk(summary_plots, ~walk(.x, grid.arrange))
```

### 2.1.2 Linear mixed effects models

*Only results from the standard RDA (not the partial RDA) are used in the final models*

```{r}
rda_ind <- 
  rda_ind %>% 
  filter(correctPC == "FALSE") 
```

```{r, message = FALSE, results = 'asis', results='asis', echo = FALSE}
map(stats, ~run_lmer(rda_ind, .x, 
                      filepath = make_lmer_path("rda", "ind", .x)))
```

### 1.1.3 Full plots

```{r,fig.width = 21, fig.height = 13}
walk(c(stats, "TOTALN"), ~print(MEGAPLOT(rda_ind, stat = .x)))
```

## 2.2 Site sampling

### 2.2.1 Summary plots

```{r, fig.width=14, fig.height=7}
rda_site <- format_rda(here(p3path, "rda_sitesampling_results.csv")) 
rda_site_tidy <- 
  rda_site %>%
  group_by(correctPC) %>%
  group_split()

summary_plots <-
  map(c(stats, "TOTALN"),
      ~ map(
        rda_site_tidy,
        rda_plotter,
        stat = .x,
        maxv = agg_mm(rda_site_tidy, .x)["max"],
        minv = agg_mm(rda_site_tidy, .x)["min"]
      ))
```

```{r, fig.width=14, fig.height=7}
walk(summary_plots, ~walk(.x, grid.arrange))
```

### 2.2.2 Linear mixed effects models

*Only results from the standard RDA (not the partial RDA) are used in the final models*

```{r}
rda_site <- 
  rda_site %>% 
  filter(correctPC == "FALSE") 
```

```{r, message = FALSE, results = 'asis', results='asis', echo = FALSE}
map(stats, ~run_lmer(rda_site, .x, 
                     filepath = make_lmer_path("rda", "site", .x)))
```

### 2.2.3 Full plots

```{r,fig.width = 21, fig.height = 13}
walk(c(stats, "TOTALN"), ~print(MEGAPLOT(rda_site, stat = .x)))
```

```{r, fig.width = 6, fig.height = 12}
results <- list(lfmm_ind, lfmm_site, rda_ind, rda_site)

filt_results <- map(results,  ~filter(.x, H == 0.5, m == 1, K == 2, phi == 1))

sub_results <- map(filt_results, \(x){
  
  stopifnot(nrow(x) %% 16 == 0 | nrow(x) %% 9 == 0)
  
  x <- 
     x %>%
     group_by(nsamp, sampstrat) %>%
     summarize_at(stats, mean, na.rm = TRUE, .groups = "keep") 
  
   colnames(x)[-(1:2)] <- map_chr(colnames(x)[-(1:2)], make_pretty_names)
   
   stopifnot(nrow(x) == 16 | nrow(x) == 9)
                    
   return(x)
})


plots <-
  map(sub_results, \(df) map(map_chr(stats, make_pretty_names), ~heat_plot(
    df,
    stat_name = .x,
    maxv = ifelse(grepl("TPR", .x), 0.849, 1),
    minv = 0
  ))) %>% transpose()

plot_ind <- map(plots, ~ggarrange(.x[[1]], .x[[3]], common.legend = TRUE, nrow = 1, legend = "none"))
plot_site <- map(plots, ~ggarrange(.x[[2]], .x[[4]], common.legend = TRUE, nrow = 1, legend = "none"))

pdf(here("plots", "GEA_ind.pdf"), width = 6, height = 12)
do.call(ggarrange, c(plot_ind, ncol = 1, align = "h"))
dev.off()

pdf(here("plots", "GEA_site.pdf"), width = 6, height = 12)
do.call(ggarrange, c(plot_site, ncol = 1, align = "h"))
dev.off()

pdf(here("plots", "GEA_legends.pdf"), width = 6, height = 12)
plot_legend <- map(plots, ~ggarrange(.x[[1]], .x[[3]], common.legend = TRUE, nrow = 1, legend = "right"))
do.call(ggarrange, c(plot_legend, ncol = 1, align = "h"))
dev.off()
```

```{r, fig.width = 6, fig.height = 12}
results <- list(lfmm_ind, lfmm_site, rda_ind, rda_site)

filt_results <- map(results,  ~filter(.x, H == 0.5, m != 1, K != 2, phi != 1))

sub_results <- map(filt_results, \(x){
  
  stopifnot(nrow(x) %% 16 == 0 | nrow(x) %% 9 == 0)
  
  x <- 
     x %>%
     group_by(nsamp, sampstrat) %>%
     summarize_at(stats, mean, na.rm = TRUE, .groups = "keep") 
  
   colnames(x)[-(1:2)] <- map_chr(colnames(x)[-(1:2)], make_pretty_names)
   
   stopifnot(nrow(x) == 16 | nrow(x) == 9)
                    
   return(x)
})


plots <-
  map(sub_results, \(df) map(map_chr(stats, make_pretty_names), ~heat_plot(
    df,
    stat_name = .x,
    maxv = ifelse(grepl("TPR", .x), 0.849, 1),
    minv = 0
  ))) %>% transpose()
plot_ind <- map(plots, ~ggarrange(.x[[1]], .x[[3]], common.legend = TRUE, nrow = 1, legend = "none"))
plot_site <- map(plots, ~ggarrange(.x[[2]], .x[[4]], common.legend = TRUE, nrow = 1, legend = "none"))

pdf(here("plots", "GEA_ind2.pdf"), width = 6, height = 12)
do.call(ggarrange, c(plot_ind, ncol = 1, align = "h"))
dev.off()

pdf(here("plots", "GEA_site2.pdf"), width = 6, height = 12)
do.call(ggarrange, c(plot_site, ncol = 1, align = "h"))
dev.off()
```
# Post-hoc analysis


```{r, fig.width = 6, fig.height = 5}
lfmm <- format_lfmm(here("p3_methods/outputs/lfmm_indsampling_results.csv")) %>% filter(lfmm_method == "ridge")
rda <- format_rda(here("p3_methods/outputs/rda_indsampling_results.csv")) %>% filter(correctPC == FALSE)
mmrr <- format_mmrr(here("p3_methods/outputs/mmrr2_indsampling_results.csv"))
gdm <- format_gdm(here("p3_methods/outputs/gdm2_indsampling_results.csv"))

gea_df <- list(lfmm = lfmm, rda = rda)
ibd_df <- list(mmrr = mmrr, gdm = gdm)

combos <- expand.grid(gea = c("lfmm", "rda"), ibd = c("mmrr", "gdm"))

result <- pmap(combos, \(gea, ibd){
  raw <- 
    left_join(gea_df[[gea]], ibd_df[[ibd]], by = c("K","phi","m","seed","H","r","it","sampstrat","nsamp")) %>% 
    filter(H == 0.5) %>%
    mutate(K = case_when(K == 2 ~ "high", TRUE ~ "low"), m = case_when(m == 1 ~ "high", TRUE ~ "low")) %>%
    dplyr::select(K, m, phi, r, H, nsamp, sampstrat, geo_coeff, TPRCOMBO_relaxed, FDRCOMBO_relaxed) %>%
    mutate(gea = !!gea, ibd = !!ibd) 

  agg <- 
    raw %>% 
    group_by(K, m, phi, r, H, nsamp, sampstrat) %>% 
    summarize_at(c("geo_coeff", "TPRCOMBO_relaxed", "FDRCOMBO_relaxed"), mean, na.rm = TRUE)%>%
    mutate(gea = !!gea, ibd = !!ibd)
  
  list(raw = raw, agg = agg)
}) %>%
transpose() %>%
map(bind_rows)


ggplot(result$agg[result$agg$nsamp == 225 & result$agg$sampstrat == "R", ], aes(x = geo_coeff, y = TPRCOMBO_relaxed)) +
  geom_smooth(data = result$raw[result$raw$nsamp == 225 & result$raw$sampstrat == "R", ], method = "lm", alpha = 0.5) +
  geom_point(data = result$raw[result$raw$nsamp == 225 & result$raw$sampstrat == "R", ], cex = 1, aes(col = m, pch = K), pch = 16, alpha = 0.5) +
  geom_point(cex = 2, aes(col = m, pch = K)) +
  xlab("Coefficient of IBD") + 
  ylab("TPR") +
  facet_wrap(ibd ~ gea, scales = "free") +
  ggplot2::theme(panel.border = ggplot2::element_rect(colour = "lightgray", fill = NA),
                strip.background = ggplot2::element_rect(fill = "lightgray", colour = "lightgray"),
                panel.background = ggplot2::element_blank()) 
```

```{r, fig.width = 11, fig.height = 10}

library(ggpubr)

pmap(combos, \(gea, ibd){
  raw <- result$raw %>% filter(ibd == !!ibd, gea == !!gea)
  agg <- result$agg %>% filter(ibd == !!ibd, gea == !!gea)
  
  ggscatter(
    raw, x = "geo_coeff", y = "TPRCOMBO_relaxed", add = "reg.line", col = rgb(0,0,0,0)) +
    facet_grid(sampstrat ~ nsamp ) +
    stat_regline_equation(aes(label = ..adj.rr.label..)) + 
    #stat_cor(label.y = 1.2) +
    geom_smooth(data = raw, method = "lm", alpha = 0.5) +
    geom_point(data = raw, cex = 1, aes(col = m, pch = K), pch = 16, alpha = 0.2) +
    geom_point(data = agg, cex = 2, aes(col = m, pch = K)) +
    xlab("Coefficient of IBD") + 
    ylab("TPR") +
    ylim(0, 1.3) +
    ggplot2::theme(panel.border = ggplot2::element_rect(colour = "lightgray", fill = NA),
                  strip.background = ggplot2::element_rect(fill = "lightgray", colour = "lightgray"),
                  panel.background = ggplot2::element_blank())  +
  ggtitle(paste(ibd, "+", gea))
  })


```

```{r, fig.width = 4.5, fig.height = 5}
raw <- result$raw %>% filter(ibd == "mmrr", gea == "lfmm", sampstrat == "R", nsamp == 225)
agg <- result$agg %>% filter(ibd == "mmrr", gea == "lfmm", sampstrat == "R", nsamp == 225)

ggscatter(
   raw, x = "geo_coeff", y = "TPRCOMBO_relaxed", add = "reg.line", col = rgb(0,0,0,0)) +
   stat_regline_equation(aes(label = ..adj.rr.label..)) + 
   #stat_cor(label.y = 1.2) +
   geom_smooth(data = raw, method = "lm", alpha = 0.5) +
   geom_point(data = raw, cex = 0.5, aes(col = m, pch = K), pch = 16, alpha = 0.3) +
   geom_point(data = agg, cex = 3, aes(col = m, pch = K)) +
   xlab("Coefficient of IBD") + 
   ylab("TPR") +
   ylim(0, 1.3) +
   ggplot2::theme(panel.border = ggplot2::element_rect(colour = "lightgray", fill = NA),
                 strip.background = ggplot2::element_rect(fill = "lightgray", colour = "lightgray"),
                 panel.background = ggplot2::element_blank()) 

```



