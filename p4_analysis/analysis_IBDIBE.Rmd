---
title: "analysis_IBDIBE"
output: html_document
---

```{r, warning=FALSE, message=FALSE, fig.width = 30, fig.height=15}
library("here")
library("sjPlot")
library("dplyr")
library("lme4")
library("viridis")
library("lmerTest")
library("ggplot2")
library("gridExtra")
library("gt")

source("analysis_functions.R")
```

# 1. MMRR

## 1.1 Individual sampling 

### 1.1.1 Summary plots

```{r, fig.width=20, fig.height=7}
mmrr_ind <- format_mmrr(here(dirname(getwd()), "p3_methods", "outputs", "mmrr_indsampling_results.csv"))

summary_hplot(mmrr_ind, "ratio_ae", colpal = "viridis", direction = -1, aggfunc = "var")
summary_hplot(mmrr_ind, "ratio_err", colpal = "viridis")
summary_hplot(mmrr_ind, "comboenv_err", divergent = TRUE)
summary_hplot(mmrr_ind, "geo_err", divergent = TRUE)
```

### 1.1.2 Model summaries

```{r}
run_lmer(mmrr_ind, "ratio_ae", table_main = "Ratio Absolute Error")
run_lmer(mmrr_ind, "ratio_err", table_main = "Ratio Error")
run_lmer(mmrr_ind, "comboenv_err", table_main = "IBE Error")
run_lmer(mmrr_ind, "geo_err", table_main = "IBD Error")
```

### 1.1.3 Megaplots

```{r, fig.width = 30, fig.height=15}
MEGAPLOT(mmrr_ind, "ratio_ae", colpal = "viridis", direction = -1)
MEGAPLOT(mmrr_ind, "ratio_err", divergent = TRUE)
MEGAPLOT(mmrr_ind, "comboenv_err", divergent = TRUE)
MEGAPLOT(mmrr_ind, "geo_err", divergent = TRUE)
```

## 1.2 Site sampling 

### 1.2.1 Summary plots

```{r, fig.width=20, fig.height=7}
mmrr_site <- format_mmrr(here(dirname(getwd()), "p3_methods", "outputs", "mmrr_sitesampling_results.csv"))

mmrr_site$ratio_ae <- abs(mmrr_site$ratio_err)
summary_hplot(mmrr_site, "ratio_ae", colpal = "viridis", direction = -1)
summary_hplot(mmrr_site, "ratio_err", divergent = TRUE)
summary_hplot(mmrr_site, "comboenv_err", divergent = TRUE)
summary_hplot(mmrr_site, "geo_err", divergent = TRUE)
```

### 1.2.2 Model summaries

```{r}
run_lmer(mmrr_site, "ratio_ae", table_main = "Ratio Absolute Error")
run_lmer(mmrr_site, "ratio_err", table_main = "Ratio Error")
run_lmer(mmrr_site, "comboenv_err", table_main = "IBE Error")
run_lmer(mmrr_site, "geo_err", table_main = "IBD Error")
```

### 1.2.3 Megaplots
```{r, fig.width = 30, fig.height=15}
MEGAPLOT(mmrr_site, "ratio_ae", colpal = "viridis", direction = -1)
MEGAPLOT(mmrr_site, "ratio_err", divergent = TRUE)
MEGAPLOT(mmrr_site, "comboenv_err", divergent = TRUE)
MEGAPLOT(mmrr_site, "geo_err", divergent = TRUE)
```

# 2. GDM

## 2.1 Individual sampling 

### 2.1.1 Summary plots

```{r, fig.width=20, fig.height=7}
gdm_ind <- format_gdm(here(dirname(getwd()), "p3_methods", "outputs", "gdm_indsampling_results.csv"))

summary_hplot(gdm_ind, "ratio_ae", colpal = "viridis", direction = -1)
summary_hplot(gdm_ind, "ratio_err", colpal = "viridis", direction = -1)
summary_hplot(gdm_ind, "comboenv_err", divergent = TRUE)
summary_hplot(gdm_ind, "geo_err", divergent = TRUE)

```

### 2.1.2 Model summaries

```{r}
run_lmer(gdm_ind, "ratio_ae", table_main = "Ratio Absolute Error")
run_lmer(gdm_ind, "ratio_err", table_main = "Ratio Error")
run_lmer(gdm_ind, "comboenv_err", table_main = "IBE Error")
run_lmer(gdm_ind, "geo_err", table_main = "IBD Error")
```

### 2.1.3 Megaplots

```{r, fig.width = 30, fig.height=15}
MEGAPLOT(gdm_ind, "ratio_ae", colpal = "viridis", direction = -1)
MEGAPLOT(gdm_ind, "ratio_err", colpal = "viridis", direction = -1)
MEGAPLOT(gdm_ind, "comboenv_err", divergent = TRUE)
MEGAPLOT(gdm_ind, "geo_err", divergent = TRUE)
```

### 2.1.4 Prop NA

Confirm that the distribution of NAs is as expected and the proportions are small

```{r,  fig.width = 30, fig.height=15}
MEGAPLOT(gdm_ind, "geo_coeff", aggfunc = "prop_na", colpal = "mako")
```

## 2.2 Site sampling 

### 2.2.1 Summary plots

```{r, fig.width=20, fig.height=7}
gdm_site <- format_gdm(here(dirname(getwd()), "p3_methods", "outputs", "gdm_sitesampling_results.csv"))

gdm_site$ratio_ae <- abs(gdm_site$ratio_err)
summary_hplot(gdm_site, "ratio_ae", colpal = "viridis", direction = -1)
summary_hplot(gdm_site, "ratio_err", divergent = TRUE)
summary_hplot(gdm_site, "comboenv_err", divergent = TRUE)
summary_hplot(gdm_site, "geo_err", divergent = TRUE)
```

### 2.2.2 Model summaries

```{r}
run_lmer(gdm_site, "ratio_ae", table_main = "Ratio Absolute Error")
run_lmer(gdm_site, "ratio_err", table_main = "Ratio Error")
run_lmer(gdm_site, "comboenv_err", table_main = "IBE Error")
run_lmer(gdm_site, "geo_err", table_main = "IBD Error")
```

### 2.2.3 Megaplots

```{r, fig.width = 30, fig.height=15}
MEGAPLOT(gdm_site, "ratio_ae", colpal = "viridis", direction = -1)
MEGAPLOT(gdm_site, "ratio_err", divergent = TRUE)
MEGAPLOT(gdm_site, "comboenv_err", divergent = TRUE)
MEGAPLOT(gdm_site, "geo_err", divergent = TRUE)
```

### 2.2.4 Prop NA

Confirm that the distribution of NAs is as expected and the proportions are small

```{r,  fig.width = 30, fig.height=15}
MEGAPLOT(gdm_site, "geo_coeff", aggfunc = "prop_na", colpal = "mako")
```

# 3. Compare results of MMRR and GDM

```{r}
plot(mmrr_ind$geo_coeff, gdm_ind$geo_coeff, col = gdm_ind$m)
legend("topleft", c("0.25", "1"), col = c("black", "red"), pch = 1)
plot(mmrr_ind$comboenv_coeff, gdm_ind$comboenv_coeff)

df <- data.frame(mmrr_ind, 
                 geo_mg = gdm_ind$geo_coeff/mmrr_ind$geo_coeff, 
                 env_mg = gdm_ind$comboenv_coeff/mmrr_ind$comboenv_coeff,
                 ratio_mg = gdm_ind$ratio/mmrr_ind$ratio )
```

```{r, fig.width=20, fig.height=7}
summary_hplot(df, "geo_mg")
summary_hplot(df, "env_mg")
summary_hplot(df, "ratio_mg")
```

```{r, fig.width = 30, fig.height=15}
MEGAPLOT(df, "geo_mg")
MEGAPLOT(df, "env_mg")
MEGAPLOT(df, "ratio_mg")
```


```{r}
plot(mmrr_site$geo_coeff, gdm_site$geo_coeff, col = gdm_site$m)
legend("topleft", c("0.25", "1"), col = c("black", "red"), pch = 1)
plot(mmrr_site$comboenv_coeff, gdm_site$comboenv_coeff)

df <- data.frame(mmrr_site, 
                 geo_mg = gdm_site$geo_coeff/mmrr_site$geo_coeff, 
                 env_mg = gdm_site$comboenv_coeff/mmrr_site$comboenv_coeff,
                 ratio_mg = gdm_site$ratio/mmrr_site$ratio )
```

```{r, fig.width=20, fig.height=7}
summary_hplot(df, "geo_mg")
summary_hplot(df, "env_mg")
summary_hplot(df, "ratio_mg")
```