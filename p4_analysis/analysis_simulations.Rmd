---
title: "Simulation results"
author: "Anusha P. Bishop, Drew E. Terasaki Hart, Ian J. Wang"
output: 
  html_document:
    toc: true
---

```{r}
library("tidyverse")
library("viridis")
library("here")

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, results = TRUE, message = FALSE)
```

# 1. Population size 

Summary of population sizes between our low (K = 1) and high (K = 2) population size scenarios:
```{r}
df <- read.csv(here("p3_methods", "outputs", "popsize_results.csv"))
df %>% group_by(K) %>% summarize(mean = mean(popsize), min = min(popsize), max = max(popsize))
```

# Phenotype-environment association 


```{r fig.width=10, fig.height=4, results = TRUE}
df <- 
  read.csv(here("p3_methods", "outputs", "phenotype_environment_results.csv")) %>%
  filter(sampstrat == "full")

df %>%
  # calculate the proportion of times the phenotype ~ environment correlations were significant
  # cor_sig is 0 if neither correlation (e.g., env1/z1 or env2/z2) was significant, 0.5 if one correlation was, and 1 if both correlations were
  summarize(mean(cor_sig == 1))
  # result 99.9% of the time phenotype and environment are correlated

# pull out the one simulation that is not significant
df %>%
  filter(cor_sig < 1)
# This makes sense: small pop size, weak selection, high migration, low spatial autocorrelation
# and even then one of the correlations is still significant!

ggdf <-
  df %>%
  mutate(cor_coeff = (cor1_coeff + cor2_coeff)/2) %>%
  # mutate to numeric
    mutate_at(c("K", "phi", "m", "H", "r"), ~as.numeric(as.character(.))) %>%
  # mutate params to get low and high
    mutate(
      K = case_when(K == min(.[["K"]]) ~ "L", K == max(.[["K"]]) ~ "H"),
      m = case_when(m == min(.[["m"]]) ~ "L", m == max(.[["m"]]) ~ "H"),
      phi = case_when(phi == min(.[["phi"]]) ~ "L", phi == max(.[["phi"]]) ~ "H"),
      H = case_when(H == min(.[["H"]]) ~ "L", H == max(.[["H"]]) ~ "H"),
      r = case_when(r == min(.[["r"]]) ~ "L", r == max(.[["r"]]) ~ "H"),
    )
  pivot_longer(c(K, m, phi, H, r))

ggplot(ggdf) +
geom_boxplot(aes(x = value, y = cor_coeff)) +
facet_wrap(~name)
```

# Phenotype-environment mismatch
```{r fig.width=10, fig.height=4}
df$eff_mismatch <- df$phi * df$mismatch_mean

ggplot(df[df$sampstrat == "full", ], aes(x = eff_mismatch, fill = factor(phi))) +
  geom_boxplot()

df %>% filter(sampstrat == "full") %>% group_by(phi, K, m, r, H) %>% summarise(mean(abs(mismatch_mean)))
df %>% filter(sampstrat == "full") %>% group_by(phi) %>% summarise(mean(abs(mismatch_mean)))
df %>% filter(sampstrat == "full") %>% group_by(H) %>% summarise(mean(abs(mismatch_mean)))

df_long <-
  df %>%
  filter(sampstrat == "full") %>%
  pivot_longer(c(phi, K, m, H, r)) %>%
  group_by(name) %>%
  mutate(value = case_when(
      value == min(value) ~ "low",
      value == max(value) ~ "high",
      TRUE ~ "NA")) %>%
  mutate(level = factor(value))

ggplot(df_long, aes(y = abs(mismatch_mean), fill = level)) +
  geom_boxplot() +
  facet_wrap(~name, nrow = 1) +
  theme(panel.background = element_rect(fill = NA, color = "gray"),
        strip.background = element_rect(color = "gray"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  ylab("|mean mismatch|")
  
```


# Genotype-environment association

```{r}
df <- read.csv(here("p3_methods", "outputs", "genotype_environment_results.csv"))
df <- df %>% mutate(adaptive = c(rep(TRUE, 8), rep(FALSE, 10000 - 8)))

cor_summary <- 
  df %>%
  group_by(adaptive, m) %>% 
  summarize(r = mean(c(cor1, cor2)), p = mean(cor_sig))
```