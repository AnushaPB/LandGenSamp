---
title: "analysis_tests"
output: html_document
---


```{r}
library("dplyr")
library("car")
library("lsmeans")
library("lme4")
library("viridis")
library("lmerTest")
library("ggplot2")
library("gridExtra")
library("MuMIn")
library("emmeans")
library("effects")
library(tidyverse)

source("analysis_functions.R")
BuRd <- c("#2066AC", "#4392C2", "#92C4DE", "#D1E5F0", "#F7F7F7", "#FDDBC6", "#F4A581", "#D5604C", "#B2182B")
BlueRed <- colorRampPalette(BuRd, interpolate="linear")
```


#Analysis

```{r}
#number of sites to sample
nsamp <- c(9, 16, 25, 2000)
#sampling strategies
sampstrat <- c("rand", "envgeo", "equi","full")

#Create dataframe with all variable combos
params_full <- expand.grid(K = c(1, 2), 
                      phi = c(0.1, 0.5),
                      m = c(0.25, 1.0),
                      seed = c(1, 2, 3),
                      H = c(0.05 , 0.5),
                      r = c(0.3, 0.6),
                      nsamp = nsamp,
                      sampstrat = sampstrat,
                      it = 0)

df <- read.csv("/Users/Anusha/Documents/GitHub/LandGenSamp/p3_methods/outputs/mmrr_sitesampling_results.csv")

df[,colnames(params_full)] <- data.frame(lapply(df[,colnames(params_full)], as.factor))

df$comboenv_err <- (df$env1_err + df$env2_err)/2
df$comboenv_coeff <- (df$env1_coeff + df$env2_coeff)/2

df$tpIBE <- ((df$env1_p < 0.05) + (df$env2_p < 0.05))/2
df$tpIBD <- as.numeric(df$geo_p < 0.05)

df$env_mae <- abs(df$comboenv_err)
df$geo_mae <- abs(df$geo_err)
df$ratio_mae <- abs(df$ratio)
#REMOVE FULL DATA FOR MODELS
moddf <- df[df$sampstrat != "full",]

moddf[!complete.cases(moddf),]

```


```{r fig.width=20, fig.height=7}
#Create dataframe with all variable combos
params <- expand.grid(K = c(1, 2), 
                      phi = c(0.1, 0.5),
                      m = c(0.25, 1.0),
                      seed = c(1, 2, 3),
                      H = c(0.05, 0.5),
                      r = c(0.3, 0.6),
                      it = 0:9)

cdf <- data.frame()
for(i in 1:nrow(params)){
  p <- params[i,]
  subdf <- df[df$K == p$K & df$phi == p$phi & df$m == p$m & df$seed == p$seed & df$H == p$H & df$r == p$r & df$it == p$it, ]
  
  full <- subdf[subdf$sampstrat == "full",]
  sub <- subdf[subdf$sampstrat != "full",]
  
  full$ratio <- (abs(full$env1_coeff) + abs(full$env2_coeff))/abs(full$geo_coeff)
  sub$ratio <- (abs(sub$env1_coeff) + abs(sub$env2_coeff))/abs(sub$geo_coeff)
  
  sub$env1_err <- sub$env1_coeff - full$env1_coeff
  sub$env2_err <- sub$env2_coeff - full$env2_coeff
  sub$comboenv_err <- (sub$env1_err + sub$env2_err)/2
  sub$geo_err <- abs(sub$geo_coeff) - abs(full$geo_coeff)
  sub$ratio_err <- sub$ratio - full$ratio
  sub$ratio_ae <- abs(sub$ratio_err)
  
  sub$geo_e <- sub$geo_coeff - full$geo_coeff
  sub$comboenv_e <- sub$comboenv_coeff - full$comboenv_coeff
  
  cdf <- rbind(cdf, sub)
}
 
df$prop_neg_sig <- (((df$env1_coeff < 0) & (df$env1_p < 0.05))  + ((df$env2_coeff < 0) & (df$env2_p < 0.05)) )/2
df$prop_neg <- ((df$env1_coeff < 0) + (df$env2_coeff < 0))/2
df$prop_sig <- ((df$env1_p < 0.05) +( df$env2_p < 0.05))/2
df$prop_sig_geo <- (df$geo_p < 0.05)
summary_hplot(df, "prop_neg", colpal = "cividis")
summary_hplot(df, "prop_sig", colpal = "cividis")

summary_hplot(df, "prop_sig_geo", colpal = "cividis")
summary_hplot(df, "prop_neg_sig", colpal = "cividis")
```

```{r}

new_df <-
  cdf %>% 
  select(K, phi, m, seed, H, r, it, sampstrat, nsamp, 
         ratio,
         env1_err, env2_err, comboenv_err, geo_err,
         ratio_err, ratio_ae) %>%
  right_join(select(df, K, phi, m, seed, H, r, it, sampstrat, nsamp, 
                   env1_coeff, env2_coeff, geo_coeff, env1_p, env2_p, geo_p))

# TEMP: removed
#write_csv(new_df, here("p3_methods", "outputs", "mmrr_sitesampling_results.csv"))

```


#CALCULATE NEW STATS
```{r,  fig.width=20, fig.height=7}

summary_hplot(cdf, "ratio_mae", colpal = "viridis", direction = -1)

summary_hplot(cdf, "ratio_err", colpal = "viridis", direction = -1)

summary_hplot(cdf, "ratio", colpal = "viridis", direction = -1)

summary_hplot(cdf, "comboenv_err", divergent = TRUE, direction = -1)

summary_hplot(cdf, "geo_err", divergent = TRUE, direction = -1)

summary_vplot(cdf, "ratio")
```

#EXPLORATORY

```{r fig.width = 30, fig.height=15}
MEGAPLOT(moddf, "geo_err", na.rm = TRUE)
```

```{r fig.width = 30, fig.height=15}
MEGAPLOT(moddf, "geo_err", option = "turbo", na.rm = TRUE)
MEGAPLOT(moddf, "comboenv_err", option = "turbo", na.rm = TRUE)
```




```{r fig.width=20, fig.height=7}
summary_vplot(df, "geo_coeff")
summary_vplot(df, "comboenv_coeff")
```

```{r fig.width=20, fig.height=7}
summary_hplot(df, "geo_err")
summary_hplot(df, "comboenv_err")
summary_hplot(df, "ratio_err")

summary_hplot(df, "geo_mae")
summary_hplot(df, "env_mae")
summary_hplot(df, "ratio_mae")
```

```{r fig.width=20, fig.height=7}
summary_hplot(df, "tpIBE")
summary_hplot(df, "tpIBD")
```

# GEO err
```{r fig.width=20, fig.height=7}
df$stat <- df$geo_err
moddf <- df[df$sampstrat != "full",]
summary_vplot(df)
summary_hplot(df)
```

# full model w/ interactions
```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + K*r +
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
fullmod <-  lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + 
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")
combos <- dredge(fullmod)
combos
```


```{r}
finalmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + 
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")
#anova
aovmod <- anova(finalmod)
aovmod

```


```{r}
ints <- c("K*phi", "K*H", "K*m", 
          "m*phi", "m*H", "m*r",
          "phi*H", "phi*r", 
          "H*r")

effplts <- list()
for(i in 1:length(ints)){
    eff <- effect(ints[i], finalmod)
    effplts[[i]] <- eff
    print(plot(eff))
}


par(mfrow=c(2,4))
for(i in 1:length(effplts)){
   p <- plot(effplts[[i]])
   print(p)
}



effplts2 <- list()

for(i in 1:length(effplts)){
    eff <- as.data.frame(effplts[[i]])
    v1 <- eff[,1]
    v2 <- eff[,2]
    p <- ggplot_gtable(ggplot_build(ggplot(eff, aes(factor(v1), linetype=factor(v2),
                                     color = factor(v2))) +
        geom_line(aes(y = fit, group=factor(v2)), size=1) +
        geom_ribbon(aes(ymin = lower, ymax = upper, group = factor(v2), fill = factor(v2), col = factor(v2)), 
                  alpha=0.2, 
                  linetype="dashed") + 
        xlab(colnames(eff)[1]) +
        ylab("") +
        scale_colour_manual(values = c("#756fd6","#30D5C8")) +
        scale_fill_manual(values = c("#756fd6", "#30D5C8")) +
        scale_x_discrete(expand = c(0.05, 0.05)) +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
              panel.background = element_blank(), axis.line = element_line(colour = "black"), text=element_text(size=21),
              plot.margin=unit(rep(0.4,4),"cm")) +
        guides(col=guide_legend(title=colnames(eff)[2], labels = levels(factor(v2))), linetype = FALSE, fill = FALSE, size = FALSE)))
    
    effplts2[[i]] <- p
    gc()

}




```


```{r fig.width = 10, fig.height = 14}
do.call(grid.arrange, c(effplts2, ncol=2))
```


# full model w/o interactions
```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```
```{r}
combos <- dredge(fullmod)
combos
```

```{r}
combos <- dredge(fullmod, rank = "BIC")
combos
```

```{r pairwise comparison of npts, fig.width=5, fig.height=5}

model <- lmer(stat ~ nsamp + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ nsamp), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of nsamp`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)

resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(nsamp))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(nsamp))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```
```{r pairwise comparison of sampstrat, fig.width=5, fig.height=5}
#TukeyHSD

model <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ sampstrat), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of sampstrat`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)


resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```

#which is best when?
```{r, fig.height=8, fig.width=5}
nsamp_sampstrat_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

```{r fig.width=10, fig.height=10}
sampstrat_nsamp_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

# model subset by sampling strategy
Determine how sampling strategy affects the relationships between the sim vars/nsamp

```{r fig.width=5, fig.height=4}
sampstrat_mod(df, sampstrat = sampstrat, full = TRUE)
```
```{r fig.width=5, fig.height=4}
nsamp_mod(df, nsamp = nsamp, full = TRUE)
```
# model subset by nsamp and sampling strategy
Determine how sampling strategy/nsamp affects the affects of the sim vars

```{r real code, fig.width=20, fig.height=4}
sampstrat_nsamp_mod_params(df, sampstrat = sampstrat, nsamp = nsamp, alpha = 0.10)
```


# ENV COMBO err
```{r fig.width=20, fig.height=7}
df$stat <- df$comboenv_err
moddf <- df[df$sampstrat != "full",]
summary_vplot(df)
summary_hplot(df)
```

# full model w/ interactions
```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + K*r +
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```

```{r}
fullmod <-  lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + 
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")
combos <- dredge(fullmod)
combos
```


```{r}
finalmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    K*m + K*phi + K*H + 
                    m*phi + m*H + m*r + 
                    phi*H + phi*r + 
                    H*r +
                    (1 | seed), moddf, na.action = "na.fail")
#anova
aovmod <- anova(finalmod)
aovmod

```


```{r}
ints <- c("K*phi", "K*H", "K*m", 
          "m*phi", "m*H", "m*r",
          "phi*H", "phi*r", 
          "H*r")

effplts <- list()
for(i in 1:length(ints)){
    eff <- effect(ints[i], finalmod)
    effplts[[i]] <- eff
    print(plot(eff))
}


par(mfrow=c(2,4))
for(i in 1:length(effplts)){
   p <- plot(effplts[[i]])
   print(p)
}



effplts2 <- list()

for(i in 1:length(effplts)){
    eff <- as.data.frame(effplts[[i]])
    v1 <- eff[,1]
    v2 <- eff[,2]
    p <- ggplot_gtable(ggplot_build(ggplot(eff, aes(factor(v1), linetype=factor(v2),
                                     color = factor(v2))) +
        geom_line(aes(y = fit, group=factor(v2)), size=1) +
        geom_ribbon(aes(ymin = lower, ymax = upper, group = factor(v2), fill = factor(v2), col = factor(v2)), 
                  alpha=0.2, 
                  linetype="dashed") + 
        xlab(colnames(eff)[1]) +
        ylab("") +
        scale_colour_manual(values = c("#756fd6","#30D5C8")) +
        scale_fill_manual(values = c("#756fd6", "#30D5C8")) +
        scale_x_discrete(expand = c(0.05, 0.05)) +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
              panel.background = element_blank(), axis.line = element_line(colour = "black"), text=element_text(size=21),
              plot.margin=unit(rep(0.4,4),"cm")) +
        guides(col=guide_legend(title=colnames(eff)[2], labels = levels(factor(v2))), linetype = FALSE, fill = FALSE, size = FALSE)))
    
    effplts2[[i]] <- p
    gc()

}




```


```{r fig.width = 10, fig.height = 14}
do.call(grid.arrange, c(effplts2, ncol=2))
```


# full model w/o interactions
```{r}
#Need to figure out if you need to subset this anova/remove n.s. variables at this stage or later
#mixed effect model
#na.action needs to be set to na.fail for dredge to work
fullmod <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + 
                    (1 | seed), moddf, na.action = "na.fail")

#anova
aovmod <- anova(fullmod)

#fixed effects (minus intercept)
efmod <- fixef(fullmod)[-1]

#print result
aovmod
efmod
```
```{r}
combos <- dredge(fullmod)
combos
```

```{r}
combos <- dredge(fullmod, rank = "BIC")
combos
```



```{r pairwise comparison of npts, fig.width=5, fig.height=5}

model <- lmer(stat ~ nsamp + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ nsamp), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of nsamp`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)

resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(nsamp))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(nsamp))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```
```{r pairwise comparison of sampstrat, fig.width=5, fig.height=5}
#TukeyHSD

model <- lmer(stat ~ nsamp + sampstrat + K + m + phi + H + r + (1 | seed), moddf, na.action = "na.fail")

pw <- emmeans(model, list(pairwise ~ sampstrat), adjust = "tukey")

resdf <- data.frame(pw$`pairwise differences of sampstrat`)
resdf$p1 <- gsub("\\ -.*", "", resdf$X1)
resdf$p2 <- gsub(".*- ", "", resdf$X1)


resdf$estimate[resdf$p.value > 0.05] <- NA

resdf$p1 <- factor(resdf$p1, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))
resdf$p2 <- factor(resdf$p2, ordered=TRUE, levels = as.character(c("envgeo","grid","rand","trans")))

ggplot(resdf, aes(p1,p2)) +
    geom_tile(aes(fill = estimate)) + 
    geom_text(aes(label = signif(estimate,  digits = 2), hjust = 0.5)) +
    scale_fill_gradient2(low = "#2066AC", mid="#F7F7F7", high = "#B2182B", midpoint = 0, limits=c(min(resdf$estimate),max(resdf$estimate))) +
    theme_bw() +
    theme(panel.border = element_blank(), panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          #legend.position = "none",
          axis.title.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.ticks.y=element_blank(),
          axis.text.x = element_text(color = "grey50", size = 12),
          axis.text.y = element_text(color = "gray50", size = 12), 
          plot.margin=unit(rep(0.4,4),"cm")) +
    coord_fixed()

```

#which is best when?
```{r, fig.height=8, fig.width=5}
nsamp_sampstrat_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

```{r fig.width=10, fig.height=10}
sampstrat_nsamp_mods(df, sampstrat = sampstrat, nsamp = nsamp)
```

# model subset by sampling strategy
Determine how sampling strategy affects the relationships between the sim vars/nsamp

```{r fig.width=5, fig.height=4}
sampstrat_mod(df, sampstrat = sampstrat, full = TRUE)
```

```{r fig.width=5, fig.height=4}
nsamp_mod(df, nsamp = nsamp, full = TRUE)
```
# model subset by nsamp and sampling strategy
Determine how sampling strategy/nsamp affects the affects of the sim vars

```{r real code, fig.width=20, fig.height=4}
sampstrat_nsamp_mod_params(df, sampstrat = sampstrat, nsamp = nsamp, alpha = 0.10)
```

