---
title: "example_simulations"
output: html_document
date: "2022-09-27"
---

This notebook was used to create plots for Figure 1

```{r}
library("raster")
library("here")
library("tidyverse")
library("viridis")
library("gridExtra")
library("vcfR")

source(here("general_functions.R"))
source(here("p4_analysis", "analysis_functions.R"))
```

```{r, fig.height = 4, fig.width = 8}
format_env <- function(env = 1, H = 0.5, r = 0.6, seed = 1){
  # read in data 
  path <- here("p1_gnxsims/MNLM/layers")
  envfile <- paste0("seed", seed, "_env", env, "_H", H*100, "_r", r*100, ".csv")
  env <- raster(as.matrix(read.csv(here(path, envfile), header = FALSE)))
  extent(env) <- c(0,100,-100,0)
  return(env)
}

get_env <- function(H = 0.5, r = 0.6){
  # read in data 
  envstk <- map(c(1,2), ~format_env(env = .x, H = H, r = r)) %>% stack()
  names(envstk) <- c("env1", "env2")
  
  # format as df  
  env <- 
    data.frame(raster::rasterToPoints(envstk), H = H, r = r) %>%
    pivot_longer(c(env1, env2), names_to = "env", values_to = "layer")
  
  return(env)
}

env <- 
  expand.grid(H = c(0.05, 0.50), r = c(0.3, 0.6)) %>%
  pmap(get_env) %>% 
  bind_rows() %>%
  mutate(group = case_when(H == 0.5 ~ "High H", TRUE ~ "Low H")) %>%
  mutate(group = case_when(r == 0.6 ~ paste0(group, " & high r"), TRUE ~ paste0(group, " & low r"))) %>%
  mutate(env = case_when(env == "env1" ~ "Env 1", env == "env2" ~ "Env 2"))

ggplot(env) +
  geom_tile(aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  theme_void() + 
  scale_fill_viridis_c(option = "mako") + 
  facet_grid(env ~ group, switch = "y") + 
  theme(legend.position = "none",
        strip.text = element_text(size = 12, margin = margin(0.1,0,0.1,0, "cm")))

```

```{r, include = false}
dfs_all <- purrr::map(list.files(here("p4_analysis/example_data/example_combos"), full.names = TRUE), get_gsd)
names(dfs_all) <- c("phi10", "H5", "r30", "D", "m25", "phi50", "K2")
dfs <- dfs_all[-6]

df <- bind_rows(new_cols(dfs[["phi10"]], "Low", "Selection\nstrength"),
          new_cols(dfs[["D"]], "High", "Selection\nstrength"),
          new_cols(dfs[["H5"]], "Low", "Spatial\nautocorrelation"),
          new_cols(dfs[["D"]], "High", "Spatial\nautocorrelation"),
          new_cols(dfs[["r30"]], "Low", "Environmental\ncorrelation"),
          new_cols(dfs[["D"]], "High", "Environmental\ncorrelation"),
          new_cols(dfs[["D"]], "Low", "Population size"),
          new_cols(dfs[["K2"]], "High", "Population size"),
          new_cols(dfs[["m25"]], "Low", "Migration"),
          new_cols(dfs[["D"]], "High", "Migration")) %>%
  mutate(param = factor(param, 
                        levels = c("Population size", "Migration", "Selection\nstrength", 
                        "Spatial\nautocorrelation", "Environmental\ncorrelation"))) %>%
  mutate(level = factor(level, levels = c("Low", "High")))

```

```{r, fig.height = 12, fig.width= 10}
# create dfs with scaled coords so that you can plot faceted plots
df1 <- data.frame(df, zw = df$z1, 
                  xw = scales::rescale(df$x, to=c(0,0.48)), yw = scales::rescale(df$y, to=c(0,0.48)))
df2 <- data.frame(df, zw = df$env1, 
                  xw = scales::rescale(df$x, to=c(0.52,1)), yw = scales::rescale(df$y, to=c(0,0.48)))
dfw <- bind_rows(df1, df2)

ggplot(dfw, aes(x = xw, y = yw, col = zw)) + 
  geom_rect(xmin = 0, xmax = 0.48, ymin = 0, ymax = 0.48, fill = "#D3D3D3") +
  geom_rect(xmin = 0.52, xmax = 1, ymin = 0, ymax = 0.48, fill = "#D3D3D3") +
  geom_point(pch = 16, size = 0.9) +
  geom_rect(xmin = 0, xmax = 0.16, ymin = 0.42, ymax = 0.48, 
            fill = "white", col = "white", lwd = 2, alpha = 0.2) +
  geom_rect(xmin = 0.52, xmax = 0.68, ymin = 0.42, ymax = 0.48,
            fill = "white", col = "white", lwd = 2, alpha = 0.2) +
  annotate("text", x = 0.08, y = 0.45, label = "Trait 1", col = "darkgray", size = 6) +
  annotate("text", x = 0.59, y = 0.45, label = "Env 1", col = "darkgray", size = 6) +
  facet_grid(param ~ level, switch = "y") +
  theme_bw() +
  scale_color_viridis_c(option = "mako", alpha = 0.9)+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), legend.position = "none",
        axis.title.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.ticks.y=element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(), 
        plot.margin=unit(rep(0.4,4),"cm"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20),
        strip.background =element_blank(),
        strip.text = element_text(color = "#282828"),
        plot.title = element_text(size=20),
        legend.key.size = unit(1, 'cm'), 
        panel.border = element_rect(colour = "gray", fill = NA, linewidth = 1)) +
  coord_fixed() 


```

```{r}
phidf <- 
  bind_rows(data.frame(dfs_all$phi10, phi = 0.1), data.frame(dfs_all$D, phi = 1.0), data.frame(dfs_all$phi50, phi = 0.5)) %>%
  pivot_longer(c(z1, z2))
  

ggplot(phidf, aes(x = x, y = y, col = value)) + 
  geom_rect(xmin = 0, xmax = 100, ymin = -100, ymax = 0, fill = "#D3D3D3", col = "#D3D3D3") +
  geom_point(pch = 16, size = 0.9) +
  facet_grid(name ~ phi, switch = "both") +
  theme_bw() +
  xlab("phi") +
  ylab("trait") +
  scale_color_viridis_c(option = "mako", alpha = 0.8)+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), legend.position = "none",
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(), 
        plot.margin=unit(rep(0.4,4),"cm"),
        strip.background =element_blank(),
        strip.text = element_text(color = "#282828", size = 11),
        plot.title = element_text(size=20),
        legend.key.size = unit(1, 'cm'), 
        panel.border = element_rect(colour = "gray", fill = NA, linewidth = 1)) +
  coord_fixed() 
```

```{r, fig.width = 7, fig.height = 7}
df <- get_gsd(here("p4_analysis/example_data/example_combos/mod-K1_phi100_m100_seed1_H50_r60_it-0_t-1000_spp-spp_0.csv"))

env1 <- format_env(env = 1, H = 0.5, r = 0.6, seed = 1)

param_set <- data.frame(K = 1, phi = 1, m = 1, seed = 1, H = 0.50, r = 0.60, it = 0)

get_samples <- function(sampstrat, nsamp, site, param_set, df){
  subIDs <- get_example_samples(param_set, sampstrat = sampstrat, nsamp = nsamp, site = site)
  subgsd_df <- df[subIDs,]
  subgsd_df$nsamp <- nsamp
  subgsd_df$sampstrat <- sampstrat
  return(subgsd_df)
}

ind_samples <-
  expand.grid(sampstrat = c("rand", "grid", "envgeo", "trans"), 
              nsamp = c(36, 81, 144, 225)) %>%
  pmap(get_samples, site = FALSE, param_set = param_set, df = df) %>%
  bind_rows() %>%
  mutate(sampstrat = case_when(sampstrat == "rand" ~ "R", 
                           sampstrat == "grid" ~ "G",
                           sampstrat == "envgeo" ~ "EG",
                           sampstrat == "trans" ~ "T")) %>%
  mutate(sampstrat = factor(sampstrat, levels = c("T", "R", "G", "EG")))

site_samples <-
  expand.grid(sampstrat = c("rand", "equi", "envgeo"), 
              nsamp = c(9, 16, 25)) %>%
  pmap(get_samples, site = TRUE, param_set = param_set, df = df) %>%
  bind_rows() %>%
  mutate(sampstrat = case_when(sampstrat == "rand" ~ "R", 
                           sampstrat == "equi" ~ "EQ",
                           sampstrat == "envgeo" ~ "EG")) %>%
  mutate(sampstrat = factor(sampstrat, levels = c("R", "EQ", "EG")))


(plt1 <-
  ggplot(ind_samples, aes(x = x, y = y)) +
  geom_raster(data = as.data.frame(env1, xy = TRUE), aes(fill = layer), alpha = 0.9) + 
  geom_point(colour = "black", pch = 3, size = 1.5, alpha = 1, stroke = 0.5) +
  coord_equal() +
  theme_void() + 
  scale_color_viridis_c(option = "mako") + 
  scale_fill_viridis_c(option = "mako") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size = 20),
        strip.text = element_text(size = 20))+
  facet_grid(sampstrat ~ nsamp, switch = "both"))

(plt2 <-
  ggplot(site_samples, aes(x = x, y = y)) +
  geom_raster(data = as.data.frame(env1, xy = TRUE), aes(fill = layer), alpha = 0.9) + 
  geom_point(colour = "black", pch = 3, size = 1.5, alpha = 0.7, stroke = 0.5) +
  coord_equal() +
  theme_void() + 
  scale_color_viridis_c(option = "mako") + 
  scale_fill_viridis_c(option = "mako") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size = 20),
        strip.text = element_text(size = 20))+
  facet_grid(sampstrat ~ nsamp, switch = "both"))

ggsave(here("plots", "indsampling.pdf"), plot = plt1)
ggsave(here("plots", "sitesampling.pdf"), plot = plt2)
```
 ```{r, fig.height = 7, fig.width = 11}
grid.arrange(ind,site)
```
