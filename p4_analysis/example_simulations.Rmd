---
title: "example_simulations"
output: html_document
date: "2022-09-27"
---

This notebook was used to create plots for Figure 1

```{r}
library("raster")
library("here")
library("tidyverse")
library("viridis")
library("gridExtra")
library("vcfR")

source(here("general_functions.R"))
source(here("p4_analysis", "analysis_functions.R"))
```

```{r, fig.height = 8, fig.width = 4}
env1 <- raster(as.matrix(read.csv(here("p4_analysis/example_data/seed1_env1_H50_r60.csv"), header = FALSE)))
env2 <- raster(as.matrix(read.csv(here("p4_analysis/example_data/seed1_env2_H50_r60.csv"), header = FALSE)))
extent(env1) <- c(0,100,-100,0)
extent(env2) <- c(0,100,-100,0)
envstk <- stack(env1, env2)
env1 <- data.frame(raster::rasterToPoints(env1), env = 1)
env2 <- data.frame(raster::rasterToPoints(env2), env = 2)
env <- rbind(env1, env2)

envpc <- RStoolbox::rasterPCA(envstk)
envpc <- envpc$map[[1]]
envpcdf <- data.frame(rasterToPoints(envpc))

p1 <- ggplot(env1) +
  geom_tile(aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  theme_void() + 
  scale_fill_viridis(option = "mako") + 
  facet_wrap(~ env, ncol = 1) + 
  theme(legend.position = "none", strip.text.x = element_blank())

p2 <- ggplot(env2) +
  geom_tile(aes(x = x, y = y, fill = layer)) +
  coord_equal() +
  theme_void() + 
  scale_fill_viridis(option = "mako") + 
  facet_wrap(~ env, ncol = 1) + 
  theme(legend.position = "none", strip.text.x = element_blank())

grid.arrange(p1, p2, ncol = 1)

```

```{r, fig.width=4, fig.height=8}
df <- get_gsd(here("p4_analysis/example_data/mod-K2_phi50_m100_seed1_H50_r60_it-0_t-1000_spp-spp_0.csv"))
p1 <- ggplot() +
  geom_tile(data = env1, aes(x = x, y = y, fill = layer), alpha = 0.5) +
  geom_point(data = df, aes(x, y, fill = z1), colour = rgb(1,1,1,0.5), pch = 21, size = 2) +
  coord_equal() +
  theme_void() + 
  scale_color_viridis(option = "mako") + 
  scale_fill_viridis(option = "mako") +
  theme(legend.position = "none")

p2 <- ggplot() +
  geom_tile(data = env1, aes(x = x, y = y, fill = layer), alpha = 0.5) +
  geom_point(data = df, aes(x, y, fill = z2), colour = rgb(1,1,1,0.5), pch = 21, size = 2) +
  coord_equal() +
  theme_void() + 
  scale_color_viridis(option = "mako") + 
  scale_fill_viridis(option = "mako") +
  theme(legend.position = "none")

grid.arrange(p1, p2, ncol = 1)
```
```{r, fig.width=4, fig.height=8}
s <- sample(nrow(df), 144)
subdf <- df[s, ]
p1 <- ggplot() +
  geom_tile(data = env1, aes(x = x, y = y, fill = layer), alpha = 0.5) +
  geom_point(data = subdf, aes(x, y, fill = z1), colour =rgb(0,0,0,0.5), pch = 21, size = 3) +
  coord_equal() +
  theme_void() + 
  scale_color_viridis(option = "mako") + 
  scale_fill_viridis(option = "mako") +
  theme(legend.position = "none")

p2 <- ggplot() +
  geom_tile(data = env1, aes(x = x, y = y, fill = layer), alpha = 0.5) +
  geom_point(data = subdf, aes(x, y, fill = z2), colour = rgb(0,0,0,0.5), pch = 21, size = 3) +
  coord_equal() +
  theme_void() + 
  scale_color_viridis(option = "mako") + 
  scale_fill_viridis(option = "mako") +
  theme(legend.position = "none")

grid.arrange(p1, p2, ncol = 1)
```


```{r}
vcf <- vcfR::read.vcfR(here("p4_analysis/example_data/mod-K2_phi50_m100_seed1_H50_r60_it-0_t-1000_spp-spp_0.vcf"))
dos <- vcf_to_dosage(vcf[1:8,])
colnames(dos) <- paste0("locus_", 1:ncol(dos))
gdf <- data.frame(df, dos)[s,]
```

```{r, fig.width = 16, fig.height = 8}
gd <- 
  gdf %>%
  pivot_longer(paste0("locus_", 1:8), names_to = "locus") %>%
  mutate(locus = gsub("locus_", "", locus)) %>%
  mutate(value = value/2) 

gd1 <- gd %>% filter(locus %in% c(1,2,3,4))

p1 <- ggplot() +
  geom_tile(data = env1, aes(x = x, y = y, fill = layer), alpha = 0.5) +
  geom_point(data = gd1, aes(x, y, col = value), size = 4) +
  coord_equal() +
  theme_void() + 
  scale_fill_viridis(option = "mako") +
  scale_color_viridis(option = "magma") +
  theme(legend.position = "none", strip.text.x = element_blank()) +
  facet_grid( ~ locus)


gd2 <- gd %>% filter(locus %in% c(5,6,7,8))

p2 <- ggplot() +
  geom_tile(data = env2, aes(x = x, y = y, fill = layer), alpha = 0.5) +
  geom_point(data = gd2, aes(x, y, col = value), size = 4) +
  coord_equal() +
  theme_void() + 
  scale_fill_viridis(option = "mako") +
  scale_color_viridis(option = "magma") +
  theme(legend.position = "none", strip.text.x = element_blank()) +
  facet_grid( ~ locus)


grid.arrange(p1, p2, nrow = 2)
```


```{r, fig.width = 8, fig.height=8}
set.seed(144)
s <- sample(nrow(dos), 144)
gendist <- as.matrix(dist(dos[s,], diag = TRUE, upper = TRUE))
p1 <- gendist  %>%
  data.frame() %>%
  rownames_to_column("sample") %>%
  gather("sample2", "gendist", -"sample") %>%
  ggplot(ggplot2::aes(x = sample, y = sample2, fill = gendist)) +
    geom_tile() +
    coord_equal() +
    scale_fill_viridis(option = "mako") +
    theme_void() +
    theme(legend.position = "none", plot.margin = unit(rep(0.5,4), "cm")) 

envdist1 <- as.matrix(dist(df$env1[s], diag = TRUE, upper = TRUE))
p2 <- envdist1  %>%
  data.frame() %>%
  rownames_to_column("sample") %>%
  gather("sample2", "gendist", -"sample") %>%
  ggplot(ggplot2::aes(x = sample, y = sample2, fill = gendist)) +
    geom_tile() +
    coord_equal() +
    scale_fill_viridis(option = "viridis") +
    theme_void() +
    theme(legend.position = "none", plot.margin = unit(rep(0.5,4), "cm")) 

envdist2 <- as.matrix(dist(df$env2[s], diag = TRUE, upper = TRUE))
p3 <- envdist2 %>%
  data.frame() %>%
  rownames_to_column("sample") %>%
  gather("sample2", "gendist", -"sample") %>%
  ggplot(ggplot2::aes(x = sample, y = sample2, fill = gendist)) +
    geom_tile() +
    coord_equal() +
    scale_fill_viridis(option = "viridis") +
    theme_void() +
    theme(legend.position = "none", plot.margin = unit(rep(0.5,4), "cm")) 

geodist <- as.matrix(dist(df[s,c("x","y")], diag = TRUE, upper = TRUE))
p4 <- geodist %>%
  data.frame() %>%
  rownames_to_column("sample") %>%
  gather("sample2", "gendist", -"sample") %>%
  ggplot(ggplot2::aes(x = sample, y = sample2, fill = gendist)) +
    geom_tile() +
    coord_equal() +
    scale_fill_viridis(option = "viridis") +
    theme_void() +
    theme(legend.position = "none", plot.margin = unit(rep(0.5,4), "cm")) 

grid.arrange(p1,p2,p3,p4,nrow = 2)

p1
```

```{r, include = false}
dfs <- purrr::map(list.files(here("p4_analysis/example_data/example_combos"), full.names = TRUE), get_gsd)
names(dfs) <- c("phi10", "H5", "r30", "D", "m25", "K2")

df <- bind_rows(new_cols(dfs[["phi10"]], "low", "selection\nstrength"),
          new_cols(dfs[["D"]], "high", "selection\nstrength"),
          new_cols(dfs[["H5"]], "low", "spatial\nautocorrelation"),
          new_cols(dfs[["D"]], "high", "spatial\nautocorrelation"),
          new_cols(dfs[["r30"]], "low", "environmental\ncorrelation"),
          new_cols(dfs[["D"]], "high", "environmental\ncorrelation"),
          new_cols(dfs[["D"]], "low", "population size"),
          new_cols(dfs[["K2"]], "high", "population size"),
          new_cols(dfs[["m25"]], "low", "migration"),
          new_cols(dfs[["D"]], "high", "migration")) %>%
  mutate(param = factor(param, 
                        levels = c("population size", "migration", "selection\nstrength", 
                        "spatial\nautocorrelation", "environmental\ncorrelation"))) %>%
  mutate(level = factor(level, levels = c("low", "high")))

```

```{r, fig.width = 18, fig.height= 9}
df1 <- data.frame(df, zw = df$z1, 
                  xw = scales::rescale(df$x, to=c(0,0.48)), yw = scales::rescale(df$y, to=c(0,0.48)))
df2 <- data.frame(df, zw = df$z2, 
                  xw = scales::rescale(df$x, to=c(0.52,1)), yw = scales::rescale(df$y, to=c(0,0.48)))
dfw <- bind_rows(df1, df2)

```

```{r, fig.height = 12, fig.width= 10}

ggplot(dfw, aes(x = xw, y = yw, col = zw)) + 
  geom_rect(xmin = 0, xmax = 0.48, ymin = 0, ymax = 0.48, fill = "#D3D3D3", col = "#D3D3D3") +
  geom_rect(xmin = 0.52, xmax = 1, ymin = 0, ymax = 0.48, fill = "#D3D3D3", col = "#D3D3D3") +
  geom_point(pch = 16, size = 0.9) +
  geom_rect(xmin = 0, xmax = 0.10, ymin = 0.42, ymax = 0.48, 
            fill = "white", col = "white", lwd = 2, alpha = 0.2) +
  geom_rect(xmin = 0.52, xmax = 0.62, ymin = 0.42, ymax = 0.48,
            fill = "white", col = "white", lwd = 2, alpha = 0.2) +
  annotate("text", x = 0.05, y = 0.45, label = "T1", col = "darkgray", size = 6) +
  annotate("text", x = 0.57, y = 0.45, label = "T2", col = "darkgray", size = 6) +
  facet_grid(param ~ level, switch = "both") +
  theme_bw() +
  scale_color_viridis_c(option = "mako", alpha = 0.8)+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), legend.position = "none",
        axis.title.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.ticks.y=element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(), 
        plot.margin=unit(rep(0.4,4),"cm"),
        strip.text.x = element_text(size = 20),
        strip.text.y = element_text(size = 20),
        strip.background =element_blank(),
        strip.text = element_text(color = "#282828"),
        plot.title = element_text(size=20),
        legend.key.size = unit(1, 'cm'), 
        panel.border = element_rect(colour = "gray", fill = NA, linewidth = 1)) +
  coord_fixed() 

```

```{r}
df <- get_gsd(here("p4_analysis/example_data/example_combos/mod-K1_phi100_m100_seed1_H50_r60_it-0_t-1000_spp-spp_0.csv"))

param_set <- data.frame(K = 1, phi = 1, m = 1, seed = 1, H = 0.50, r = 0.60, it = 0)

grd_site <- map2(c("rand", "equi", "envgeo"), c("R", "EQ", "EG"), 
                 plot_example_samples, site = TRUE, env1 = env1, df = df)

grd_ind <- map2(c("rand", "grid", "envgeo", "trans"), 
               c("R", "G", "EG", "T"), plot_example_samples, site = FALSE, env1 = env1, df = df)

site0 <- do.call(grid.arrange, c(grd_site, nrow = 1, ncol = 4))
site <- grid.arrange(site0, 
                    left = grid::textGrob("site", 
                                          x = 0, 
                                          hjust = 0.9, 
                                          vjust = 1,
                                          rot = 90,
                                          gp=gpar(fontsize=20)))

ind0 <- do.call(grid.arrange, c(grd_ind, nrow = 1))
ind <- grid.arrange(ind0, 
                    left = grid::textGrob("individual", 
                                          x = 0, 
                                          hjust = 0.6, 
                                          vjust = 1,
                                          rot = 90,
                                          gp=gpar(fontsize=20)))

```
```{r, fig.height = 7, fig.width = 11}
grid.arrange(ind,site)
```
